<!DOCTYPE html>
<!-- saved from url=(0056)https://board.flatassembler.net/topic.php?t=20690#205424 -->
<html dir="ltr" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="author" content="Tomasz Grysztar"><meta name="description" content="Learning binary file formats (work in progress)">
  <title>flat assembler - Learning binary file formats (work in progress)</title>
  <meta name="twitter:card" content="summary">
  <meta property="og:title" content="Learning binary file formats (work in progress)">
  <meta property="og:image" content="https://flatassembler.net/images/flatassembler.gif">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./flat assembler - Learning binary file formats (work in progress)_files/phpVB2.css" type="text/css">
</head>

<body>

  <p class="mediumtext">
    <span class="maintitle">flat assembler</span><br>Message board for the users of flat assembler.
  </p>

  <p class="navigation">
    <a class="boldlink" href="https://board.flatassembler.net/index.php">Home</a>
    <!--<a class="boldlink" href="faq.php">FAQ</a>-->
    <a class="boldlink" href="https://board.flatassembler.net/search.php">Search</a>
    <a class="boldlink" href="https://board.flatassembler.net/profile.php?mode=register">Register</a>
    <br>
    <a class="boldlink" href="https://board.flatassembler.net/privmsg.php?folder=inbox">Log in to check your private messages</a>
    <a class="boldlink" href="https://board.flatassembler.net/login.php">Log in</a>
  </p>

  <div class="container">

<table class="lineup">
  <tbody><tr>
    <td align="left" valign="middle">
      <img src="./flat assembler - Learning binary file formats (work in progress)_files/fasm.png" border="0" alt="" align="center">
      <span class="largetext"><a href="https://board.flatassembler.net/index.php"><b>Index</b></a>
      <b>&gt; <a href="https://board.flatassembler.net/forum.php?f=27">Assembly</a> &gt; Learning binary file formats (work in progress)</b></span><br>
      <br>
      <b><span class="smalltext">
      </span></b></td>
  </tr>
</tbody></table>

        

            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td nowrap="" class="toprow leftcol foldable" valign="middle"><span class="toprowtext">Author </span></td>
                <td nowrap="" class="toprow"><table width="100%" border="0" cellpadding="0" cellspacing="0"><tbody><tr>
                 <td nowrap="" class="toprow" valign="middle"><span class="toprowtext">Thread</span></td>
                 <td nowrap="" class="toprow" valign="middle" align="right"><a href="https://board.flatassembler.net/post.php?mode=newtopic&amp;f=27"><img src="./flat assembler - Learning binary file formats (work in progress)_files/post.gif" border="0" alt="Post new topic" align="middle"></a> <a href="https://board.flatassembler.net/post.php?mode=reply&amp;t=20690"><img src="./flat assembler - Learning binary file formats (work in progress)_files/reply-locked.gif" border="0" alt="This topic is locked: you cannot edit posts or make replies." align="middle"></a></td></tr>
                </tbody></table></td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row1">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row1">
                  <a name="205073"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">15 Jul 2018, 11:48</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title="Learning binary file formats (work in progress)"><em style="font-style: italic">This is an unfinished book-like tutorial on the executable/object formats, with a heavy assistance of fasmg. I started with PE and I plan to follow up with ELF (including object varieties), then perhaps Mach-O and possibly some others. While writing the main text I have also been posting little sidenotes and outtakes, now <a href="https://board.flatassembler.net/topic.php?t=21901" target="_blank" class="postlink">gathered elsewhere</a>.</em>
<br>

<br>
<strong style="font-weight: bold">Introduction</strong>
<br>
<a href="https://board.flatassembler.net/topic.php?t=20690#205385" class="postlink">Getting started with fasmg</a>
<br>

<br>
<strong style="font-weight: bold">Chapter 1
<br>
PE (Portable Executable)</strong>
<br>

<br>
<a href="https://board.flatassembler.net/topic.php?t=20690#205424" class="postlink">1.1  Building a simple program</a>
<br>
<a href="https://board.flatassembler.net/topic.php?t=20690#205472" class="postlink">1.2  Adding relocations</a>
<br>
<a href="https://board.flatassembler.net/topic.php?t=20690#205473" class="postlink">1.3  Making a library</a>
<br>
<a href="https://board.flatassembler.net/topic.php?t=20690#205474" class="postlink">1.4  Embedding resources</a>
<br>
<a href="https://board.flatassembler.net/topic.php?t=20690#205476" class="postlink">1.5  Moving to 64 bits with PE+</a>
<br>
<a href="https://board.flatassembler.net/topic.php?t=20690#205549" class="postlink">1.6  Experimenting further</a>
<br>

<br>
<strong style="font-weight: bold">Chapter 2
<br>
ELF (Executable and Linkable Format)</strong>
<br>

<br>
<a href="https://board.flatassembler.net/topic.php?t=20690#205881" class="postlink">2.1  A minimal executable file</a>
<br>
<em style="font-style: italic">To be continued...</em></div>

        <br><br>

        <table width="95%" cellpadding="8" cellspacing="0" align="center" class="attachcontainer">
        <tbody><tr><td><table width="100%" cellpadding="2" cellspacing="0" class="attachtable">
        <tbody><tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Description:</b></span></td>
                <td width="75%" class="attachrow">
                        <span class="genmed">Learning binary file formats: Common files</span></td>
                <td rowspan="4" align="center" width="10%" class="attachrow"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_clip.gif" alt="" border="0"><br><a href="https://board.flatassembler.net/download.php?id=7872" target="_blank" class="genmed"><b>Download</b></a></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Filename:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">common.zip</span></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Filesize:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">47.2 KB</span></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Downloaded:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">1678 Time(s)</span></td>
        </tr>
        </tbody></table></td></tr>
        </tbody></table>
        <br>
        <table width="95%" cellpadding="8" cellspacing="0" align="center" class="attachcontainer">
        <tbody><tr><td><table width="100%" cellpadding="2" cellspacing="0" class="attachtable">
        <tbody><tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Description:</b></span></td>
                <td width="75%" class="attachrow">
                        <span class="genmed">Learning binary file formats: Chapter 1 files</span></td>
                <td rowspan="4" align="center" width="10%" class="attachrow"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_clip.gif" alt="" border="0"><br><a href="https://board.flatassembler.net/download.php?id=7871" target="_blank" class="genmed"><b>Download</b></a></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Filename:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">chapter1.zip</span></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Filesize:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">27.48 KB</span></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Downloaded:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">1607 Time(s)</span></td>
        </tr>
        </tbody></table></td></tr>
        </tbody></table>
        <br>
        <table width="95%" cellpadding="8" cellspacing="0" align="center" class="attachcontainer">
        <tbody><tr><td><table width="100%" cellpadding="2" cellspacing="0" class="attachtable">
        <tbody><tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Description:</b></span></td>
                <td width="75%" class="attachrow">
                        <span class="genmed">Learning binary file formats: Chapter 2 files</span></td>
                <td rowspan="4" align="center" width="10%" class="attachrow"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_clip.gif" alt="" border="0"><br><a href="https://board.flatassembler.net/download.php?id=7990" target="_blank" class="genmed"><b>Download</b></a></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Filename:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">chapter2.zip</span></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Filesize:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">4.47 KB</span></td>
        </tr>
        <tr>
                <td width="15%" class="attachrow"><span class="genmed"><b>Downloaded:</b></span></td>
                <td width="75%" class="attachrow"><span class="genmed">1370 Time(s)</span></td>
        </tr>
        </tbody></table></td></tr>
        </tbody></table>
        <br>

<div class="signature"></div><span class="smalltext"><br><br>Last edited by Tomasz Grysztar on 17 Feb 2022, 11:16; edited 5 times in total</span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row1"><a href="https://board.flatassembler.net/topic.php?p=205073#205073"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  15 Jul 2018, 11:48</span></td>
                <td valign="middle" class="row1">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205073"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row2">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row2">
                  <a name="205385"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">02 Aug 2018, 02:22</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title="Introduction - Getting started with fasmg"><strong style="font-weight: bold">Introduction
<br>
Getting started with fasmg</strong>
<br>

<br>
To learn the inner workings of binary files we are going to construct them manually, with help of <a href="https://flatassembler.net/docs.php?article=fasmg" target="_blank" class="postlink">fasmg</a>. This is a command line tool that takes the source text, which is like a script that defines how to assemble the binary file out of its components (down to bytes or even individual bits) and saves such produced file under a given name:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>fasmg source.asm output.bin    </pre></div>
<br>
The source contains a series commands, each on its own line of text. One of the basic instructions is DB, which defines data as a series of bytes:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>db <span class="code_number">49</span><span class="code_symbol">,</span><span class="code_number">50</span><span class="code_symbol">,</span><span class="code_number">51</span>    </pre></div>If the source text looks like above, fasmg is going to produce a file that contains three bytes with the given values (that happen to be the ASCII codes of digits from 1 to 3).
<br>
The definitions of data can use units larger than a byte, among other available instruction there is DW to define 16-bit (2-byte) "words", DD for 32-bit (4-byte) "double words" and DQ for 64-bit (8-byte) "quad words". They all store values as little-endian (there are easy methods to define big-endian data too, but we are not going to need them here).
<br>
A data can also be defined as a string of bytes copied as-is from the source text. Such sequence of characters needs to be enclosed with either single or double quotes:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>db <span class="code_string">'Hi!'</span>    </pre></div>The DUP operator allows to define several duplicates of the same value:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>db <span class="code_number">3</span> dup <span class="code_string">'!'</span>    </pre></div>
<br>
Any definition of data has assigned an address, starting from zero. Data can be given a name, by writing it before the DB or other similar instruction as a so-called label:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>digits db <span class="code_number">49</span><span class="code_symbol">,</span><span class="code_number">50</span><span class="code_symbol">,</span><span class="code_number">51</span><span class="code_symbol">,</span><span class="code_number">52</span><span class="code_symbol">,</span><span class="code_number">53</span><span class="code_symbol">,</span><span class="code_number">54</span><span class="code_symbol">,</span><span class="code_number">55</span><span class="code_symbol">,</span><span class="code_number">56</span><span class="code_symbol">,</span><span class="code_number">57</span>    </pre></div>This name can then be used in expressions and its value is the address of the first byte of the data that it labeled. The following produces a 32-bit value equal to the address of "digits" (most likely zero):    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>dd digits    </pre></div>
<br>
What makes the assembler especially useful is that we can define various things out of order and fasmg is going to compute and put the right values in the right places, like:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>dd null <span class="code_symbol">-</span> digits
digits db <span class="code_number">49</span><span class="code_symbol">,</span><span class="code_number">50</span><span class="code_symbol">,</span><span class="code_number">51</span><span class="code_symbol">,</span><span class="code_number">52</span><span class="code_symbol">,</span><span class="code_number">53</span><span class="code_symbol">,</span><span class="code_number">54</span><span class="code_symbol">,</span><span class="code_number">55</span><span class="code_symbol">,</span><span class="code_number">56</span><span class="code_symbol">,</span><span class="code_number">57</span>
null db <span class="code_number">0</span>    </pre></div>The file generated from the above sample is going to start with a 32-bit value equal to the difference between the "null" and "digits" addresses, that is the length of the string of digits.
<br>
A label can also be created without a data definition on the same line, in such case the name needs to be followed by a colon:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>dd eof
db <span class="code_string">'Hello!'</span>
eof<span class="code_symbol">:</span>    </pre></div>A name can also be assigned any computed value with the = or := operator. The := defines a constant, like a label, while = defines a variable whose value may be changed by another similar assignment later.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>dd length
digits db <span class="code_number">49</span><span class="code_symbol">,</span><span class="code_number">50</span><span class="code_symbol">,</span><span class="code_number">51</span><span class="code_symbol">,</span><span class="code_number">52</span><span class="code_symbol">,</span><span class="code_number">53</span><span class="code_symbol">,</span><span class="code_number">54</span><span class="code_symbol">,</span><span class="code_number">55</span><span class="code_symbol">,</span><span class="code_number">56</span><span class="code_symbol">,</span><span class="code_number">57</span>
null db <span class="code_number">0</span>
length <span class="code_symbol">:=</span> null <span class="code_symbol">-</span> digits    </pre></div>The $ is a special name that always equals to the current address:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>dd length
digits db <span class="code_number">49</span><span class="code_symbol">,</span><span class="code_number">50</span><span class="code_symbol">,</span><span class="code_number">51</span><span class="code_symbol">,</span><span class="code_number">52</span><span class="code_symbol">,</span><span class="code_number">53</span><span class="code_symbol">,</span><span class="code_number">54</span><span class="code_symbol">,</span><span class="code_number">55</span><span class="code_symbol">,</span><span class="code_number">56</span><span class="code_symbol">,</span><span class="code_number">57</span>
length <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> digits
db <span class="code_number">0</span>    </pre></div>Assigning the value of $ to a name has the same effect as defining such named label.
<br>
Various portions of executable files may end up loaded to a different addresses in memory. The instruction ORG allows to change the assumed address for the data definitions that follow, without altering the position in file. This changes the value of $ and the values of all labels defined after this point. Since this decouples $ from the position within the generated file, there is another special name $% that always equals to the position in file regardless of the assumed address.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>org <span class="code_number">0x100</span>
start<span class="code_symbol">:</span>
offset <span class="code_symbol">=</span> $%
dd start   <span class="code_annotation">;</span> <span class="code_annotation">equals</span> <span class="code_annotation">0x100</span> <span class="code_annotation">(256)</span>
dd offset  <span class="code_annotation">;</span> <span class="code_annotation">equals</span> <span class="code_annotation">0</span>    </pre></div>The above sample contains some comments, in assembly language they are started with a semicolon.
<br>
A data can be defined with ? in place of its value. This creates a so-called reserved bytes, which are stripped when at the end of file but not when they are followed by a regular data.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>db ?   <span class="code_annotation">;</span> <span class="code_annotation">this</span> <span class="code_annotation">one</span> <span class="code_annotation">is</span> <span class="code_annotation">not</span> <span class="code_annotation">cut</span>
db <span class="code_string">'a'</span>
db ?   <span class="code_annotation">;</span> <span class="code_annotation">this</span> <span class="code_annotation">one</span> <span class="code_annotation">is</span> <span class="code_annotation">cut</span>    </pre></div>When a reserved byte ends up in the output file, it has a zero value.
<br>
The SECTION instruction in the language of fasmg is very similar to ORG, except that it strips all the reserved bytes that were defined just before it, similarly to how they are normally stripped at the end of file. This is going to become useful when the file we make needs to contain sections that are larger in memory than in the file, with additional bytes reserved at the end of each section.
<br>
In addition to special symbols $ and $% there is also $%%. It equals the current offset in file and unlike $% it does not count the reserved bytes (which may end up discarded):    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>dd SIZE_IN_FILE
dd SIZE_IN_MEMORY
section <span class="code_number">0x1000</span>
ADDRESS_IN_MEMORY <span class="code_symbol">=</span> $
OFFSET_IN_FILE <span class="code_symbol">=</span> $%
db <span class="code_string">'example'</span>
db <span class="code_number">0x30</span> dup ?
SIZE_IN_MEMORY <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> ADDRESS_IN_MEMORY
SIZE_IN_FILE <span class="code_symbol">:=</span> $%% <span class="code_symbol">-</span> OFFSET_IN_FILE    </pre></div>To get a better view of the things that get assembled we can use the attached "listing.inc" script to generate a listing of generated bytes next to the instructions that made them. To use this extension we can put the following command as the first line of our source:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>include <span class="code_string">'listing.inc'</span>    </pre></div>Alternatively, we can insert this line into assembly with the -i switch from the command line. Depending on the operating system we may need to escape the space character in different ways. In Windows this may look like:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>fasmg source.asm output.bin <span class="code_symbol">-</span>i <span class="code_string">"include</span> <span class="code_string">'listing.inc'"</span>    </pre></div>and in Linux:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>fasmg source.asm output.bin <span class="code_symbol">-</span>i include<span class="code_symbol">\</span> <span class="code_string">'listing.inc'</span>    </pre></div>The listing should be saved in file "output.lst" and look like this:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre><span class="code_symbol">[</span><span class="code_number">0000000000000000</span><span class="code_symbol">]</span> <span class="code_number">00000000</span><span class="code_symbol">:</span> <span class="code_number">07</span> <span class="code_number">00</span> <span class="code_number">00</span> <span class="code_number">00</span>              dd SIZE_IN_FILE
<span class="code_symbol">[</span><span class="code_number">0000000000000004</span><span class="code_symbol">]</span> <span class="code_number">00000004</span><span class="code_symbol">:</span> <span class="code_number">37</span> <span class="code_number">00</span> <span class="code_number">00</span> <span class="code_number">00</span>              dd SIZE_IN_MEMORY
<span class="code_symbol">[</span><span class="code_number">0000000000000008</span><span class="code_symbol">]</span>                                    section <span class="code_number">0x1000</span>
<span class="code_symbol">[</span><span class="code_number">0000000000001000</span><span class="code_symbol">]</span>                                    ADDRESS_IN_MEMORY <span class="code_symbol">=</span> $
<span class="code_symbol">[</span><span class="code_number">0000000000001000</span><span class="code_symbol">]</span>                                    OFFSET_IN_FILE <span class="code_symbol">=</span> $%
<span class="code_symbol">[</span><span class="code_number">0000000000001000</span><span class="code_symbol">]</span> <span class="code_number">00000008</span><span class="code_symbol">:</span> <span class="code_number">65</span> <span class="code_number">78</span> <span class="code_number">61</span> <span class="code_number">6D</span> <span class="code_number">70</span> <span class="code_number">6C</span> <span class="code_number">65</span>     db <span class="code_string">'example'</span>
<span class="code_symbol">[</span><span class="code_number">0000000000001007</span><span class="code_symbol">]</span>                                    db <span class="code_number">0x30</span> dup ?
<span class="code_symbol">[</span><span class="code_number">0000000000001037</span><span class="code_symbol">]</span>                                    SIZE_IN_MEMORY <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> ADDRESS_IN_MEMORY
<span class="code_symbol">[</span><span class="code_number">0000000000001037</span><span class="code_symbol">]</span>                                    SIZE_IN_FILE <span class="code_symbol">:=</span> $%% <span class="code_symbol">-</span> OFFSET_IN_FILE    </pre></div>The value in square brackets is the assumed address in memory at which the instruction is assembled, the number with a colon is the offset within the file at which the bytes are written and what follows are their values (everything in hexadecimal).
<br>

<br>
When the assembly scripts we write become more complex, we may notice some repeating patterns of commands that would become much more pleasant if we could replace them with specialized instructions. To help there, the assembler allows us to define macro-instructions. This way we can create a new command, named however we wish, and make it execute a customized sequence of instructions every time it is encountered. For example:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro distanceto address
        dd address <span class="code_symbol">-</span> $
end macro    </pre></div>defines a new instruction that can be used like:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>distanceto digits    </pre></div>and it then simply executes the following command:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>dd digits <span class="code_symbol">-</span> $    </pre></div>Naturally, macro-instructions often end up being much more complex. Let us have a look at one that is almost as simple as the above one, but is going to be very useful to us on numerous occasions:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro align? pow2<span class="code_symbol">*,</span>value<span class="code_symbol">:</span>?
        db  <span class="code_symbol">(-</span>$<span class="code_symbol">)</span> and <span class="code_symbol">(</span>pow2<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span>  dup value
end macro    </pre></div>The ? after the name of a macro makes the name case-insensitive. The first of the arguments is marked with * to tell the assembler that it is required, while the second argument is optional with default value being a question mark. So if we use the macro like this:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>ALIGN <span class="code_number">4</span>    </pre></div>the instruction that gets executed is:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>db  <span class="code_symbol">(-</span>$<span class="code_symbol">)</span> and <span class="code_symbol">(</span><span class="code_number">4</span><span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span>  dup ?    </pre></div>This macro allows to align the structures we generate so that the address of the next data we define is a multiple of a given power of two.
<br>

<br>
We are going to learn more about the language of fasmg when a need arises, but at the moment we know enough to start making some files.</div>

<div class="signature"></div><span class="smalltext"></span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row2"><a href="https://board.flatassembler.net/topic.php?p=205385#205385"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  02 Aug 2018, 02:22</span></td>
                <td valign="middle" class="row2">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205385"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row1">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row1">
                  <a name="205424"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">04 Aug 2018, 23:44</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title="Portable Executable - Building a simple program"><strong style="font-weight: bold">Chapter 1
<br>
PE (Portable Executable)</strong>
<br>

<br>
The road we are going to take is to learn inner workings of file formats by constructing some files from scratch. This approach is focused on experimentation, so we will use samples designed in a way that encourages playing with them and learning through direct experience.
<br>

<br>
The first file we construct is going to be an executable for Windows operating system, in the format called Portable Executable.
<br>

<br>
<a href="https://docs.microsoft.com/en-us/windows/desktop/debug/pe-format" target="_blank" class="postlink">PE</a> was designed in 1993 for Windows NT (the first 32-bit system in the family), and has been used from then on by the 32-bit and 64-bit implementations of Windows. Subsequently it has been adopted for some other uses, like EFI, but at this time we are going to focus on its original environment.
<br>

<br>
<strong style="font-weight: bold">1.1  Building a simple program</strong>
<br>

<br>
Before we go on, a few preparations. We should take the ALIGN macro we discussed earlier, it is going to become useful quite soon. We may also need to create some machine code for the actual program inside our executable and for this we need to include an instruction set for a processor architecture we need to work with. Our first choice is going to be very traditional, the 32-bit x86 architecture, so we include an instruction set for processors compatible with 80386:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>include <span class="code_string">'80386.inc'</span>
use32    </pre></div>USE32 is a command provided by the '80386.inc' package, it chooses to assemble instructions for 32-bit mode (if we did not specify it, the default mode would be 16-bit, for historical reasons).
<br>

<br>
A term that often pops up when discussing PE files is the program image. This refers to the layout of the program after it is loaded into memory to be executed, which is not necessarily the same as the structure of the program in the file on disk. The executable needs to define a mapping of sections of the file onto the corresponding areas in memory.
<br>

<br>
Nevertheless, both the file on disk and image in memory start the same way - with the headers. These structures from the beginning of file become the initial portion of loaded program, at the address called the base of the image. All the other sections created in memory have to be placed after that.
<br>

<br>
Any PE executable is constructed with an assumed value for the base of the image, for 32-bit programs this is usually 0x400000. We are going to define a constant with this value and use it as the base for our labels:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>IMAGE_BASE <span class="code_symbol">:=</span> <span class="code_number">0x400000</span>
org IMAGE_BASE    </pre></div>Therefore all the labels that we define are going to correspond to addresses in the program image.
<br>

<br>
The next two constants choose the alignment settings for the disk and for the memory. This is one of the sources of discrepancy between the layouts of the file and of the image.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>FILE_ALIGNMENT <span class="code_symbol">:=</span> <span class="code_number">512</span>
SECTION_ALIGNMENT <span class="code_symbol">:=</span> <span class="code_number">4096</span>    </pre></div>The standard choice of file alignment makes sure that every section in the file starts on a new sector of the disk (traditionally hard drives have a sector size of 512 bytes), to optimize the performance of reading and mapping a single section into memory.
<br>

<br>
In memory, the sections are aligned to the size of page (which is 4096 bytes in the basic setup of x86 CPU). This is partly because memory can be allocated only in such increments, but also because different sections may require distinct attributes for the memory (like write-protection) and CPU can have them set up only for entire pages at once.
<br>

<br>
These constants are better left with the standard values. While it is possible to tweak them in such way that it should still be possible for the operating system to construct the image, the loader may distrust and refuse to load an executable with a non-standard layout. There are also some additional constraints if chosen alignment in memory is smaller than the size of page (we may get back to it later).
<br>

<br>
It is time to start writing the headers. The very first bytes of the file are usually an unique signature of the format, but in the case of PE a matter is a bit more complicated. At the time when PE format was designed DOS was still a popular operating system and many of the new formats - like NE (16-bit format used by the earliest versions of Windows), LE (used by OS/2, but also by drivers in Windows 9x) and finally PE - were based on the old MZ format used for the .EXE files in DOS. All these formats were made in such way that the initial portion of the file was a valid MZ program that could be executed by DOS, usually it was a tiny program that just displayed a message like "This program cannot be run in DOS mode". This small program was called a stub and its MZ header was extended to contain a special field, ignored by older software, containing the offset of the actual new executable header later in the file.
<br>

<br>
This way it was even possible to have an executable that would contain two versions of the same software - one for DOS and one for Windows. This was not an usual thing to do, though. Mostly, the stub programs were just informing in one way or the other that the file was not intended to be run from DOS.
<br>

<br>
Nowadays we do not need to worry much about someone mistakenly trying to execute our PE file in DOS, therefore we are going to make a minimal stub - not a real program, just something that resembles one enough for our PE executable to be valid:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>Stub<span class="code_symbol">:</span>
        .Signature                      dw <span class="code_string">"MZ"</span>
        .BytesInLastSector              dw SIZE_OF_STUB mod <span class="code_number">512</span>
        .NumberOfSectors                dw <span class="code_symbol">(</span>SIZE_OF_STUB<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)/</span><span class="code_number">512</span> <span class="code_symbol">+</span> <span class="code_number">1</span>
        .NumberOfRelocations            dw <span class="code_number">0</span>
        .NumberOfHeaderParagraphs       dw SIZE_OF_STUB_HEADER <span class="code_symbol">/</span> <span class="code_number">16</span>
                                        db <span class="code_number">0x3C</span> <span class="code_symbol">-</span> <span class="code_symbol">(</span>$<span class="code_symbol">-</span>Stub<span class="code_symbol">)</span> dup <span class="code_number">0</span>
        .NewHeaderOffset                dd Header<span class="code_symbol">-</span>IMAGE_BASE   

align <span class="code_number">16</span>

SIZE_OF_STUB_HEADER <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> Stub

        <span class="code_annotation">;</span> <span class="code_annotation">The</span> <span class="code_annotation">code</span> <span class="code_annotation">of</span> <span class="code_annotation">a</span> <span class="code_annotation">DOS</span> <span class="code_annotation">program</span> <span class="code_annotation">would</span> <span class="code_annotation">go</span> <span class="code_annotation">here.</span>

SIZE_OF_STUB <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> Stub    </pre></div>What is important here is that at the position 0x3C from the beginning of MZ header there should be a 32-bit field containing the offset to actual PE header. We fill most of the MZ header with zeros up to that point, normally there are some fields important for the MZ format, but we do not intend to make a functional DOS program.
<br>

<br>
We compute the offset of a main PE header by subtracting IMAGE_BASE from its address (available through a label that we are going to define below). For all the headers there is such clear correspondence between addresses in image and positions in file.
<br>

<br>
We also fill a couple of fields in the MZ header that are crucial for its integrity, namely the size of the header and of the entire program. The header is measured in 16-byte units (in DOS they were called paragraphs) and the "align 16" is there to make sure that this is a multiple of 16 (though in this case nothing needs to be done, the position immediately after the NewHeaderOffset is 64). The size of DOS program is given as a count of 512-byte sectors, but the last one of them is allowed to be not fully filled and BytesInLastSector gives the number of bytes in it.
<br>

<br>
On a side note, when a label starts with a dot, it belongs to the namespace of a regular label that preceded it. The labels defined here could be accessed from elsewhere with identifiers like "Stub.Signature" or "Stub.NewHeaderOffset".
<br>

<br>
With the stub ready, we can move on to the main header, this is where the actual PE signature is going to be. This header must be aligned on 8-byte boundary, hence we put an "align 8" here, though it again does nothing (but if we had put a real DOS program above, the position in file might have been misaligned).
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>align <span class="code_number">8</span>

Header<span class="code_symbol">:</span>
        .Signature                      dw <span class="code_string">"PE"</span><span class="code_symbol">,</span><span class="code_number">0</span>
        .Machine                        dw <span class="code_number">0x14C</span> <span class="code_annotation">;</span> <span class="code_annotation">IMAGE_FILE_MACHINE_I386</span>
        .NumberOfSections               dw NUMBER_OF_SECTIONS
        .TimeDateStamp                  dd %t
        .PointerToSymbolTable           dd <span class="code_number">0</span>
        .NumberOfSymbols                dd <span class="code_number">0</span>
        .SizeOfOptionalHeader           dw SectionTable <span class="code_symbol">-</span> OptionalHeader
        .Characteristics                dw <span class="code_number">0x102</span> <span class="code_annotation">;</span> <span class="code_annotation">IMAGE_FILE_32BIT_MACHINE</span> <span class="code_annotation">+</span> <span class="code_annotation">IMAGE_FILE_EXECUTABLE_IMAGE</span>    </pre></div>There are some constants used here that are given names in the official specifications of PE format. To make the generated data more tangible in the first demonstration, we use their values directly and leave the names in the comments. But as we continue to work with these examples, later we may prefer to include an additional header into our script with the definitions of all these constants and just use the names.
<br>

<br>
According to the plan, the first example is going to be for a 32-bit mode of a x86 CPU and we state this in the Machine field, but also by including IMAGE_FILE_32BIT_MACHINE value in the Characteristics. The latter field is a set of flags and there is another one that we unquestionably need there - IMAGE_FILE_EXECUTABLE_IMAGE tells that the file contains an executable code.
<br>

<br>
PE is closely related to COFF, which is a format of object files that are created by compilers as an intermediate stage before they are finally linked to create code that can be executed. These two formats have mostly identical headers (except for the PE signature, which is missing in COFF) and they share the values of various constants. The value of IMAGE_FILE_EXECUTABLE_IMAGE has been used by COFF to distinguish the object files from the executable ones (when we later talk about ELF format, which superseded COFF on the Unix systems, we are going to see that it has similar variants).
<br>

<br>
In NumberOfSections we need to state how many sections do we plan to create. We do not know that yet, but we can use the name of a constant that we define later with the right value.
<br>

<br>
TimeDateStamp needs to tell when the file was created, in the "milliseconds since Unix epoch" format. A special symbol %t is provided by fasmg with such value.
<br>

<br>
PointerToSymbolTable and NumberOfSymbols are another relic of the COFF format. They are not used in PE and we just fill them with zeros.
<br>

<br>
After the main header comes the so-called "optional header". This name is also a legacy of COFF, as this structure contains a crucial information about the entry point of an executable code and is definitely required for any PE image. It was only optional in COFF, when the file could be an intermediate object, not yet made into an executable.
<br>

<br>
The optional header follows immediately after the main one and is in turn followed by the section table. Thus to obtain the size that we need to put in SizeOfOptionalHeader we just compute the difference between the OptionalHeader and SectionTable addresses.
<br>

<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>OptionalHeader<span class="code_symbol">:</span>
        .Magic                          dw <span class="code_number">0x10B</span>
        .MajorLinkerVersion             db <span class="code_number">0</span>
        .MinorLinkerVersion             db <span class="code_number">0</span>
        .SizeOfCode                     dd <span class="code_number">0</span>
        .SizeOfInitializedData          dd <span class="code_number">0</span>
        .SizeOfUninitializedData        dd <span class="code_number">0</span>
        .AddressOfEntryPoint            dd EntryPoint<span class="code_symbol">-</span>IMAGE_BASE
        .BaseOfCode                     dd <span class="code_number">0</span>
        .BaseOfData                     dd <span class="code_number">0</span>    </pre></div>
<br>

<br>
The value of Magic identifies a variant of PE format. For classic 32-bit PE it is always 0x10B (a ZMAGIC value which COFF inherited from the old a.out format); while 0x20B is used to mark PE+ files, a variety intended mainly for 64-bit architectures. They slightly differ in format of the structures that follow, we are going to look at these differences later, when we create a 64-bit executable.
<br>

<br>
Of the other fields in this initial portion of the "optional" header the only important one is AddressOfEntryPoint, which should contain an address of entry point relative to the base of the image. The specification calls this kind of value an RVA (Relative Virtual Address), while VA (Virtual Address) is just a direct address in memory. To compute an RVA we simply subtract IMAGE_BASE from the address (VA). The EntryPoint label is going to be defined later, in the code of our program.
<br>

<br>
MajorLinkerVersion and MinorLinkerVersion are filled by a linker when it creates the executable, this allows the linker to put some mark of authorship on the executable. We are not a linker, so we can decide for ourselves what kind of mark to leave there. A simple choice is just zeros.
<br>

<br>
The other fields, like SizeOfCode and AddressOfCode, are remnants of the original COFF model (which in turn inherited them from the old a.out) and they do not really matter to PE loader. Various kinds of code and data sections may be intermixed within the image and the true authority on their sizes and placement is held by the section table. The fields here are just a supplementary information and, for instance, if there were several sections of data with some code in-between, the sum of their sizes would serve only a statistical role. 
<br>

<br>
If we wanted to be pedantic about it, we could fill these fields with values copied from our section table, but for now we just leave them zeroed. An additional sign of the irrelevancy of these numbers is that in PE+ the entire BaseOfData field is readily sacrificed to allow the subsequent ImageBase field to be enlarged to 64-bit without moving the later ones.
<br>

<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .ImageBase                      dd IMAGE_BASE
        .SectionAlignment               dd SECTION_ALIGNMENT
        .FileAlignment                  dd FILE_ALIGNMENT
        .MajorOperatingSystemVersion    dw <span class="code_number">3</span>
        .MinorOperatingSystemVersion    dw <span class="code_number">10</span>
        .MajorImageVersion              dw <span class="code_number">0</span>
        .MinorImageVersion              dw <span class="code_number">0</span>
        .MajorSubsystemVersion          dw <span class="code_number">3</span>
        .MinorSubsystemVersion          dw <span class="code_number">10</span>
        .Win32VersionValue              dd <span class="code_number">0</span>
        .SizeOfImage                    dd SIZE_OF_IMAGE
        .SizeOfHeaders                  dd SIZE_OF_HEADERS
        .CheckSum                       dd <span class="code_number">0</span>
        .Subsystem                      dw <span class="code_number">2</span> <span class="code_annotation">;</span> <span class="code_annotation">IMAGE_SUBSYSTEM_WINDOWS_GUI</span>
        .DllCharacteristics             dw <span class="code_number">0</span>
        .SizeOfStackReserve             dd <span class="code_number">4096</span>
        .SizeOfStackCommit              dd <span class="code_number">4096</span>
        .SizeOfHeapReserve              dd <span class="code_number">65536</span>
        .SizeOfHeapCommit               dd <span class="code_number">0</span>
        .LoaderFlags                    dd <span class="code_number">0</span>
        .NumberOfRvaAndSizes            dd NUMBER_OF_RVA_AND_SIZES    </pre></div>
<br>
In contrast, this part of headers holds many important values. All the constants we defined earlier - the base of the image and the alignment values - are stored here exactly as they are. We also use two constants we have not yet defined to fill SizeOfImage and SizeOfHeaders, we are going to calculate these values later.
<br>

<br>
MajorOperatingSystemVersion together with MinorOperatingSystemVersion as well as MajorSubsystemVersion with MinorSubsystemVersion declare what version of operating system is needed to execute the image. Programs created for older versions are allowed to run on the newer ones, and this example is not going to use any features that were not in Windows since the beginning, so to not unnecessarily limit the execution of program we put 3.10 there (this is the version number of first Windows NT that supported PE format).
<br>

<br>
MajorImageVersion and MinorImageVersion could indicate the version of our program, but they are usually unused. And Win32VersionValue is just a reserved field, with currently unknown purpose; it needs to be zero. The same goes for LoaderFlags further below.
<br>

<br>
CheckSum is a value computed over all the bytes of the executable that can be used to check whether the file has been modified in any way since the time when it was calculated. Normal programs are not required to have a valid checksum, so in this example we are going to skip this step. But even when we plan to compute the checksum, the value of this field should not partake in the summation so it is better to have it initially zeroed.
<br>

<br>
Subsystem identifies the environment where the program wants to be run. For normal applications this is either GUI or console.
<br>

<br>
DllCharacteristics is an additional set of flags supplementary to Characteristics in the main header. This is another case of a misnomer, the flags here are not necessarily related to whether the file is a DLL. Nevertheless, at the moment we do not need to set any of them.
<br>

<br>
SizeOfStackReserve and SizeOfStackCommit set up the size of stack for our program, the former states how large the stack is allowed to become, while the latter determines the initial size. We go with a single page for both. SizeOfHeapReserve and SizeOfHeapCommit provide similar settings for the local heap, which is a pool from which program may allocate small blocks of memory whenever needed. We set up some usual values, though we are not going to use heap in our simple program.
<br>

<br>
Finally, NumberOfRvaAndSizes specifies how many pairs consisting of a relative address and a size follow immediately after. This forms a sort of catalogue of specialized data structures present in the image. They come in a fixed order, as folows:
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>RvaAndSizes<span class="code_symbol">:</span>
        .Export.Rva                     dd <span class="code_number">0</span>
        .Export.Size                    dd <span class="code_number">0</span>
        .Import.Rva                     dd ImportTable<span class="code_symbol">-</span>IMAGE_BASE
        .Import.Size                    dd ImportTable.End<span class="code_symbol">-</span>ImportTable
        .Resource.Rva                   dd <span class="code_number">0</span>
        .Resource.Size                  dd <span class="code_number">0</span>
        .Exception.Rva                  dd <span class="code_number">0</span>
        .Exception.Size                 dd <span class="code_number">0</span>
        .Certificate.Rva                dd <span class="code_number">0</span>
        .Certificate.Size               dd <span class="code_number">0</span>
        .BaseRelocation.Rva             dd <span class="code_number">0</span>
        .BaseRelocation.Size            dd <span class="code_number">0</span>
        .Debug.Rva                      dd <span class="code_number">0</span>
        .Debug.Size                     dd <span class="code_number">0</span>
        .Architecture.Rva               dd <span class="code_number">0</span>
        .Architecture.Size              dd <span class="code_number">0</span>
        .GlobalPtr.Rva                  dd <span class="code_number">0</span>
        .GlobalPtr.Size                 dd <span class="code_number">0</span>
        .TLS.Rva                        dd <span class="code_number">0</span>
        .TLS.Size                       dd <span class="code_number">0</span>
        .LoadConfig.Rva                 dd <span class="code_number">0</span>
        .LoadConfig.Size                dd <span class="code_number">0</span>
        .BoundImport.Rva                dd <span class="code_number">0</span>
        .BoundImport.Size               dd <span class="code_number">0</span>
        .IAT.Rva                        dd <span class="code_number">0</span>
        .IAT.Size                       dd <span class="code_number">0</span>
        .DelayImport.Rva                dd <span class="code_number">0</span>
        .DelayImport.Size               dd <span class="code_number">0</span>
        .COMPlus.Rva                    dd <span class="code_number">0</span>
        .COMPlus.Size                   dd <span class="code_number">0</span>
        .Reserved.Rva                   dd <span class="code_number">0</span>
        .Reserved.Size                  dd <span class="code_number">0</span>    </pre></div>Out of many possible tables that PE image may declare this way, we provide just one. The import table is necessary for us to gain access to the functions of Windows API. When we define it below, we need to demark it with ImportTable and ImportTable.End labels.
<br>

<br>
Here the optional header ends, immediately followed by the section table - a crucial component of the headers.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>SectionTable<span class="code_symbol">:</span>

        .1.Name                         dq <span class="code_symbol">+</span><span class="code_string">'.text'</span>
        .1.VirtualSize                  dd Section.1.End <span class="code_symbol">-</span> Section.1
        .1.VirtualAddress               dd Section.1 <span class="code_symbol">-</span> IMAGE_BASE
        .1.SizeOfRawData                dd Section.1.SIZE_IN_FILE
        .1.PointerToRawData             dd Section.1.OFFSET_IN_FILE
        .1.PointerToRelocations         dd <span class="code_number">0</span>
        .1.PointerToLineNumbers         dd <span class="code_number">0</span>
        .1.NumberOfRelocations          dw <span class="code_number">0</span>
        .1.NumberOfLineNumbers          dw <span class="code_number">0</span>
        .1.Characteristics              dd <span class="code_number">0x60000000</span> <span class="code_annotation">;</span> <span class="code_annotation">IMAGE_SCN_MEM_EXECUTE</span> <span class="code_annotation">+</span> <span class="code_annotation">IMAGE_SCN_MEM_READ</span>

        .2.Name                         dq <span class="code_symbol">+</span><span class="code_string">'.rdata'</span>
        .2.VirtualSize                  dd Section.2.End <span class="code_symbol">-</span> Section.2
        .2.VirtualAddress               dd Section.2 <span class="code_symbol">-</span> IMAGE_BASE
        .2.SizeOfRawData                dd Section.2.SIZE_IN_FILE
        .2.PointerToRawData             dd Section.2.OFFSET_IN_FILE
        .2.PointerToRelocations         dd <span class="code_number">0</span>
        .2.PointerToLineNumbers         dd <span class="code_number">0</span>
        .2.NumberOfRelocations          dw <span class="code_number">0</span>
        .2.NumberOfLineNumbers          dw <span class="code_number">0</span>
        .2.Characteristics              dd <span class="code_number">0x40000000</span> <span class="code_annotation">;</span> <span class="code_annotation">IMAGE_SCN_MEM_READ</span>

SectionTable.End<span class="code_symbol">:</span>    </pre></div>Our table contains two records, defining two sections with different attributes. The '.text' is a usual name for a section containing executable code, in other words: the text of the program. The '.rdata' is going to contain all kinds of read-only data we need, this should be enough for the first sample. 
<br>

<br>
The name of the section is stored in an 8-byte field, padded with zeros. We use DQ to define this as a 64-bit value and convert the string to a number with the + operator, in order to enable range check. A DQ with a string argument would allow text of any length and it would simply pad it so that the size was a multiple of 8 bytes. By converting text to a number we ensure that it has to fit in a single 64-bit cell so the field is always exactly 8 bytes long.
<br>

<br>
VirtualAddress and VirtualSize define the boundaries of a section within the image in memory. The starting address needs to be set up consistently with the SectionAlignment, we need to keep this in mind later when we define the labels used here.
<br>

<br>
PointerToRawData and SizeOfRawData define the placement of the contents of a section within the file. Both values have to be aligned accordingly to the FileAlignment, so it is possible for section's data in file to be larger than the size of that section in memory. It can also be the other way around, since a section may reserve more memory than it contains actual data. In an extreme case the size in file might be 0 when a section contains nothing but reserved memory. We are going to compute the constants used there with help of the $% symbol, after ensuring the proper alignment within the file.
<br>

<br>
The fields that refer to relocations and line numbers are in these structures because COFF objects use them, but for PE images they should be zeroed. Although PE could contain some relocations, they would be very different from the ones used by COFF and defined elsewhere (we are going to discuss them a bit later, the first example can work without them).
<br>

<br>
Characteristics contain various flags, here we just mark both sections as a readable memory and the code section as executable. These settings translate directly into the attributes of allocated memory pages, so they are quite important. We could also use values like IMAGE_SCN_CNT_CODE and IMAGE_SCN_CNT_INITIALIZED_DATA (connected to the fields like SizeOfCode and SizeOfInitializedData in the main header), but this would mostly be just decorative.
<br>

<br>
The end of the section table is also the end of the contents of the headers. Before we go further, we are going to fill up a few of the related constants. They are a bit redundant, the effect would be the same if we plugged the corresponding expressions directly in the places where we used their names earlier. But the use of middlemen constants helps to comfortably alter the way they are computed when this comes up in the future.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>NUMBER_OF_RVA_AND_SIZES <span class="code_symbol">:=</span> <span class="code_symbol">(</span>SectionTable<span class="code_symbol">-</span>RvaAndSizes<span class="code_symbol">)/</span><span class="code_number">8</span>
NUMBER_OF_SECTIONS <span class="code_symbol">:=</span> <span class="code_symbol">(</span>SectionTable.End<span class="code_symbol">-</span>SectionTable<span class="code_symbol">)/</span><span class="code_number">40</span>
SIZE_OF_HEADERS <span class="code_symbol">:=</span> Section.1.OFFSET_IN_FILE    </pre></div>To count the number of records in a table we divide the total size by the length of a single entry as defined in the specification. As long as we define the tables correctly, everything should add up.
<br>

<br>
As for the total size of headers, it has to be rounded up to the nearest multiple of FILE_ALIGNMENT, and this is at the same time the position where the contents of the initial section is going to begin. Therefore we can cheat a little and shift the responsibility to another constant, the one defining the offset in file for the first section.
<br>

<br>
However, to correctly position our initial section we need to do some actual work.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>align SECTION_ALIGNMENT
Section.1<span class="code_symbol">:</span>    </pre></div>First, we move in the image to the nearest multiple of SECTION_ALIGNMENT, by adding the right amount of reserved data (this is the default behavior of our ALIGN macro). This allows us to define the label corresponding to the start of the first section in memory.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section $%%
align FILE_ALIGNMENT<span class="code_symbol">,</span><span class="code_number">0</span>
Section.1.OFFSET_IN_FILE<span class="code_symbol">:</span>    </pre></div>Then we use the SECTION instruction of the assembler to cut off all the reserved bytes so they do not get included in file. In this particular case the only reserved bytes to discard are the ones made by the previous alignment. 
<br>

<br>
With the use of $%% as an argument to SECTION we temporarily switch from in-memory addressing to one tracing the actual position in file. This makes the address $ equal to the offset $% until we change this with another SECTION or ORG.
<br>

<br>
After that we use the alignment macro once more, this time to align the offset in file to the nearest multiple of FILE_ALIGNMENT. While the previous alignment just moved our address in memory without adding anything to file, this time we provide the second argument to the macro to make it write the necessary amount of zeroed bytes to the output.
<br>

<br>
Then Section.1.OFFSET_IN_FILE can be defined simply as a label, thanks to the address being the same as the position in file.
<br>

<br>
Finally we switch back to in-memory addressing, at the address of Section.1 label. A simple ORG would suffice, but we use SECTION for the visual appeal:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section Section.1

        EntryPoint<span class="code_symbol">:</span>

                push    <span class="code_number">0</span>
                push    CaptionString
                push    MessageString
                push    <span class="code_number">0</span>
                call    <span class="code_symbol">[</span>MessageBoxA<span class="code_symbol">]</span>

                push    <span class="code_number">0</span>
                call    <span class="code_symbol">[</span>ExitProcess<span class="code_symbol">]</span> 

Section.1.End<span class="code_symbol">:</span>    </pre></div>This is the entirety of our executable code, with entry point defined at the start of the section. There are just two types of x86 instructions used in this example, PUSH to store the arguments for the API functions on the stack, and CALL to execute the functions. In the next section we are going to set up the pointers to the functions and the character strings for MessageBoxA.
<br>

<br>
Now we need to perform the full alignment ritual again, this time to set up the position of the second section. We also calculate the size of the first one in file simply by computing the difference between the aligned offsets.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>align SECTION_ALIGNMENT
Section.2<span class="code_symbol">:</span>

section $%%
align FILE_ALIGNMENT<span class="code_symbol">,</span><span class="code_number">0</span>
Section.1.SIZE_IN_FILE <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> Section.1.OFFSET_IN_FILE
Section.2.OFFSET_IN_FILE<span class="code_symbol">:</span>    </pre></div>With the proper alignments done, we move on to the second section, the one where we are going to put all the data.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section Section.2    </pre></div>
<br>
We start with the import table, which allows us to direct the loader to fill up our pointers with the addresses of the functions from system DLL files. This is actually a complex structure that consist of several smaller tables. First, there is an Import Directory Table.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        ImportTable<span class="code_symbol">:</span>

                .1.ImportLookupTableRva         dd KernelLookupTable<span class="code_symbol">-</span>IMAGE_BASE
                .1.TimeDateStamp                dd <span class="code_number">0</span>
                .1.ForwarderChain               dd <span class="code_number">0</span>
                .1.NameRva                      dd KernelDLLName<span class="code_symbol">-</span>IMAGE_BASE
                .1.ImportAddressTableRva        dd KernelAddressTable<span class="code_symbol">-</span>IMAGE_BASE

                .2.ImportLookupTableRva         dd UserLookupTable<span class="code_symbol">-</span>IMAGE_BASE
                .2.TimeDateStamp                dd <span class="code_number">0</span>
                .2.ForwarderChain               dd <span class="code_number">0</span>
                .2.NameRva                      dd UserDLLName<span class="code_symbol">-</span>IMAGE_BASE
                .2.ImportAddressTableRva        dd UserAddressTable<span class="code_symbol">-</span>IMAGE_BASE

                                                dd <span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span>    </pre></div>Every record in this main table declares a single DLL file from which we want to import functions. The table ends with a record that has all five fields zeroed.
<br>

<br>
NameRva is a relative address of the name of DLL file. We are going to put these names near the end of the import-related data.
<br>

<br>
ImportLookupTableRva and ImportAddressTableRva point to two parallel tables. The former contains relative addresses of structures declaring functions to be imported, while the latter is going to contain actual addresses of imported functions. The functions can be in any order, as long as the same one is used for both tables. When our image is loaded into memory, the operating system is going to look for all the functions defined by the first table and fill the second one with corresponding addresses.
<br>

<br>
TimeDateStamp and ForwarderChain fields are used when the imports are bound - that is, when the second table is pre-filled with addresses of imported functions to save time when loading the image. This obviously can work correctly only when all the addresses in imported library are exactly as they were upon binding, and TimeDateStamp keeps the value of the timestamp of the DLL to provide a way to verify that it is exactly the same file. If the timestamps match, the loader can skip looking up all the functions, otherwise it does it as usual. Our imports are not bound, we need the loader to fill the addresses for us, therefore we keep TimeDateStamp zeroed in every case.
<br>

<br>
If the imports were bound, ForwarderChain would be interpreted as an index of a function that could not be bound because it was a forwarded import from another DLL. The value of the corresponding entry in the import address table would be an index of another such function, and so on. If we wanted to indicate that there were no such functions, we should put -1 in this field, but since we do not use binding (as indicated by the zeroed TimeDateStamp) this value is irrelevant.
<br>

<br>
Now we need to create lookup tables and address tables for every DLL. The initial contents of the parallel tables should be the same, they both should contain relative addresses to the lookup entries defining the functions. When the image is loaded, the IAT is rewritten with the matching addresses. We can then use these values directly, therefore we label them with names of the functions and this is exactly what is needed to get the CALL instructions in our code to work.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                KernelLookupTable<span class="code_symbol">:</span>
                                dd ExitProcessLookup<span class="code_symbol">-</span>IMAGE_BASE
                                dd <span class="code_number">0</span>
                KernelAddressTable<span class="code_symbol">:</span>
                ExitProcess     dd ExitProcessLookup<span class="code_symbol">-</span>IMAGE_BASE <span class="code_annotation">;</span> <span class="code_annotation">this</span> <span class="code_annotation">is</span> <span class="code_annotation">going</span> <span class="code_annotation">to</span> <span class="code_annotation">be</span> <span class="code_annotation">replaced</span> <span class="code_annotation">with</span> <span class="code_annotation">the</span> <span class="code_annotation">address</span> <span class="code_annotation">of</span> <span class="code_annotation">the</span> <span class="code_annotation">function</span>
                                dd <span class="code_number">0</span>

                UserLookupTable<span class="code_symbol">:</span>
                                dd MessageBoxALookup<span class="code_symbol">-</span>IMAGE_BASE
                                dd <span class="code_number">0</span>
                UserAddressTable<span class="code_symbol">:</span>
                MessageBoxA     dd MessageBoxALookup<span class="code_symbol">-</span>IMAGE_BASE <span class="code_annotation">;</span> <span class="code_annotation">this</span> <span class="code_annotation">is</span> <span class="code_annotation">going</span> <span class="code_annotation">to</span> <span class="code_annotation">be</span> <span class="code_annotation">replaced</span> <span class="code_annotation">with</span> <span class="code_annotation">the</span> <span class="code_annotation">address</span> <span class="code_annotation">of</span> <span class="code_annotation">the</span> <span class="code_annotation">function</span>
                                dd <span class="code_number">0</span>    </pre></div>
<br>
We import only one function from each DLL, so the tables are short. The end of a table is marked by a zeroed entry.
<br>

<br>
Next come the lookup definitions for individual functions. Each such structure contains a 16-bit hint followed by the name of the function as a null-terminated string. The hint is an index into the export table of DLL, where the loader may look for the function with such name. If the hint fails, the loader continues to search for the function as usual, thus we do not have to know the right values to put there.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                ExitProcessLookup<span class="code_symbol">:</span>
                        .Hint   dw <span class="code_number">0</span>
                        .Name   db <span class="code_string">'ExitProcess'</span><span class="code_symbol">,</span><span class="code_number">0</span>
                                align <span class="code_number">2</span>
                MessageBoxALookup<span class="code_symbol">:</span>
                        .Hint   dw <span class="code_number">0</span>
                        .Name   db <span class="code_string">'MessageBoxA'</span><span class="code_symbol">,</span><span class="code_number">0</span>    </pre></div>Even though this most often does not matter, the 16-bit values should be aligned to their "natural boundary" (that is their address should be a multiple of 2), while the string could end on an uneven address. For this reason we put an ALIGN between the records.
<br>

<br>
Finally, we conclude the import table with the names of DLL files that we import. They are a plain null-terminated strings.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                KernelDLLName   db <span class="code_string">'KERNEL32.DLL'</span><span class="code_symbol">,</span><span class="code_number">0</span>
                UserDLLName     db <span class="code_string">'USER32.DLL'</span><span class="code_symbol">,</span><span class="code_number">0</span>

        ImportTable.End<span class="code_symbol">:</span>    </pre></div>Since we are at it, we can define a couple more strings here. The import table has ended, but we can keep placing more data into the '.rdata' section and we still need to define the caption and the content for the message box that this program wants to show.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        CaptionString db <span class="code_string">"PE</span> <span class="code_string">tutorial"</span><span class="code_symbol">,</span><span class="code_number">0</span>
        MessageString db <span class="code_string">"I</span> <span class="code_string">am</span> <span class="code_string">alive</span> <span class="code_string">and</span> <span class="code_string">well!"</span><span class="code_symbol">,</span><span class="code_number">0</span>

Section.2.End<span class="code_symbol">:</span>    </pre></div>This marks the end of our second section and, in fact, of the entire image. All that is left in another sequence of memory and file alignments.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>align SECTION_ALIGNMENT
SIZE_OF_IMAGE <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> IMAGE_BASE

section $%%
align FILE_ALIGNMENT<span class="code_symbol">,</span><span class="code_number">0</span>
Section.2.SIZE_IN_FILE <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> Section.2.OFFSET_IN_FILE    </pre></div>This time there is no next section, so we do not define labels and constants that would refer to it. Instead we define SIZE_OF_IMAGE, which needed to be a multiple of SECTION_ALIGNMENT too.
<br>

<br>
This is it, the source for our first PE image is ready (a copy is in the attached "basic.asm" file). We can now assemble it into a file with the "exe" extension and let it run.
<br>

<br>
We can also combine it with the "listing.inc" script to contemplate the binary data juxtaposed with the commands that generated it. You may notice that numerous lines from "80386.inc" show up in the listing. To get rid of them, we can hide the included file inside a simple macro:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro use? file<span class="code_symbol">*</span>
        include file
end macro

use <span class="code_string">'80386.inc'</span>
use32    </pre></div>While we are at it, we may also incorporate the "ntimage.inc" file that defines some of the constants associated with PE format:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>use <span class="code_string">'ntimage.inc'</span>    </pre></div>This allows easier experimentation with some of the values that earlier we hard-coded:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .Characteristics                dw IMAGE_FILE_32BIT_MACHINE <span class="code_symbol">+</span> IMAGE_FILE_EXECUTABLE_IMAGE    </pre></div>For example, we can add IMAGE_DLLCHARACTERISTICS_NX_COMPAT to DllCharacteristics, allowing to enable DEP (Data Execution Prevention).    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .DllCharacteristics             dw IMAGE_DLLCHARACTERISTICS_NX_COMPAT    </pre></div>This can make the IMAGE_SCN_MEM_EXECUTE bit in our section definitions really mean something.
<br>

<br>
It was a first step towards making our source more maintainable. Another one could be to automate some of the tasks. For example, we can generate all the entries in the section table with a simple repetition:
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>SectionTable<span class="code_symbol">:</span>

repeat NUMBER_OF_SECTIONS<span class="code_symbol">,</span> n<span class="code_symbol">:</span><span class="code_number">1</span>

        .n.Name                         dq Section.n.NAME
        .n.VirtualSize                  dd Section.n.End <span class="code_symbol">-</span> Section.n
        .n.VirtualAddress               dd Section.n <span class="code_symbol">-</span> IMAGE_BASE
        .n.SizeOfRawData                dd Section.n.SIZE_IN_FILE
        .n.PointerToRawData             dd Section.n.OFFSET_IN_FILE
        .n.PointerToRelocations         dd <span class="code_number">0</span>
        .n.PointerToLineNumbers         dd <span class="code_number">0</span>
        .n.NumberOfRelocations          dw <span class="code_number">0</span>
        .n.NumberOfLineNumbers          dw <span class="code_number">0</span>
        .n.Characteristics              dd Section.n.CHARACTERISTICS

end repeat

SectionTable.End<span class="code_symbol">:</span>    </pre></div>REPEAT allows to assemble the same piece of source in multiple copies and in every copy it replaces the name of the counter with the corresponding number. We defined a counter named "n" that starts from 1 and this generates the same labels as we had previously there.
<br>

<br>
This approach requires that we define several more constants. We also have to change how the NUMBER_OF_SECTIONS is defined, we can no longer compute it from the size of the section table, as this would create a circular dependence:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>NUMBER_OF_SECTIONS <span class="code_symbol">:=</span> <span class="code_number">2</span>

Section.1.NAME <span class="code_symbol">:=</span> <span class="code_symbol">+</span><span class="code_string">'.text'</span>
Section.1.CHARACTERISTICS <span class="code_symbol">:=</span> IMAGE_SCN_MEM_EXECUTE <span class="code_symbol">+</span> IMAGE_SCN_MEM_READ
Section.2.NAME <span class="code_symbol">:=</span> <span class="code_symbol">+</span><span class="code_string">'.rdata'</span>
Section.2.CHARACTERISTICS <span class="code_symbol">:=</span> IMAGE_SCN_MEM_READ    </pre></div>We can, however, take it a step further and automate everything by making a macro to define sections:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>CURRENT_SECTION <span class="code_symbol">=</span> <span class="code_number">0</span>

macro section? name<span class="code_symbol">*,</span> characteristics<span class="code_symbol">:</span><span class="code_number">0</span>

        CURRENT_SECTION <span class="code_symbol">=</span> CURRENT_SECTION <span class="code_symbol">+</span> <span class="code_number">1</span>

        repeat <span class="code_number">1</span><span class="code_symbol">,</span> new<span class="code_symbol">:</span>CURRENT_SECTION<span class="code_symbol">,</span> previous<span class="code_symbol">:</span>CURRENT_SECTION<span class="code_symbol">-</span><span class="code_number">1</span>

                Section.previous.End<span class="code_symbol">:</span>
                align SECTION_ALIGNMENT

                Section.new.NAME <span class="code_symbol">:=</span> <span class="code_symbol">+</span>name
                Section.new.CHARACTERISTICS <span class="code_symbol">:=</span> characteristics
                Section.new<span class="code_symbol">:</span>

                section $%%
                align FILE_ALIGNMENT<span class="code_symbol">,</span><span class="code_number">0</span>
                if previous <span class="code_symbol">&gt;</span> <span class="code_number">0</span>
                        Section.previous.SIZE_IN_FILE <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> Section.previous.OFFSET_IN_FILE
                end if
                Section.new.OFFSET_IN_FILE<span class="code_symbol">:</span>

                org Section.new

        end repeat

end macro    </pre></div>We named the macro the same as the instruction of fasmg - this is allowed, and inside our macro the name still refers to the original instruction.
<br>

<br>
To define labels and constants that correspond to enumerated section entries, we need to extract the number from the CURRENT_SECTION variable and somehow place it into names. The trick in fasmg is to use REPEAT with just a single repetition, solely for the purpose of defining counters that get replaced with numbers before the repeated text is assembled.
<br>

<br>
The macro does everything that we have previously done manually when starting a new section. The ending address and the size in file get defined only when the next section is started, so we need to define an additional false (not counted into the total number) section at the end, together with the definition of the NUMBER_OF_SECTIONS and the SIZE_OF_IMAGE.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>postpone

        NUMBER_OF_SECTIONS <span class="code_symbol">:=</span> CURRENT_SECTION
        section <span class="code_string">''</span>
        SIZE_OF_IMAGE <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> IMAGE_BASE

end postpone    </pre></div>With help of POSTPONE we can place this next to the definition of macro, for a better organization of source. Whatever is inside such block, gets assembled at the end of text.
<br>

<br>
This macro required us to learn a bit more of the assembler's trickery, but it makes the section definitions much more pleasant to the eye:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section <span class="code_string">'.text'</span><span class="code_symbol">,</span> IMAGE_SCN_MEM_EXECUTE <span class="code_symbol">+</span> IMAGE_SCN_MEM_READ

        EntryPoint<span class="code_symbol">:</span>

                push    <span class="code_number">0</span>
                push    CaptionString
                push    MessageString
                push    <span class="code_number">0</span>
                call    <span class="code_symbol">[</span>MessageBoxA<span class="code_symbol">]</span>

                push    <span class="code_number">0</span>
                call    <span class="code_symbol">[</span>ExitProcess<span class="code_symbol">]</span> 

section <span class="code_string">'.rdata'</span><span class="code_symbol">,</span> IMAGE_SCN_MEM_READ

        ImportTable<span class="code_symbol">:</span>

                .1.ImportLookupTableRva         dd KernelLookupTable<span class="code_symbol">-</span>IMAGE_BASE
                .1.TimeDateStamp                dd <span class="code_number">0</span>
                .1.ForwarderChain               dd <span class="code_number">0</span>
                .1.NameRva                      dd KernelDLLName<span class="code_symbol">-</span>IMAGE_BASE
                .1.ImportAddressTableRva        dd KernelAddressTable<span class="code_symbol">-</span>IMAGE_BASE

                .2.ImportLookupTableRva         dd UserLookupTable<span class="code_symbol">-</span>IMAGE_BASE
                .2.TimeDateStamp                dd <span class="code_number">0</span>
                .2.ForwarderChain               dd <span class="code_number">0</span>
                .2.NameRva                      dd UserDLLName<span class="code_symbol">-</span>IMAGE_BASE
                .2.ImportAddressTableRva        dd UserAddressTable<span class="code_symbol">-</span>IMAGE_BASE

                                                dd <span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span>

                KernelLookupTable<span class="code_symbol">:</span>
                                dd ExitProcessLookup<span class="code_symbol">-</span>IMAGE_BASE
                                dd <span class="code_number">0</span>
                KernelAddressTable<span class="code_symbol">:</span>
                ExitProcess     dd ExitProcessLookup<span class="code_symbol">-</span>IMAGE_BASE <span class="code_annotation">;</span> <span class="code_annotation">this</span> <span class="code_annotation">is</span> <span class="code_annotation">going</span> <span class="code_annotation">to</span> <span class="code_annotation">be</span> <span class="code_annotation">replaced</span> <span class="code_annotation">with</span> <span class="code_annotation">the</span> <span class="code_annotation">address</span> <span class="code_annotation">of</span> <span class="code_annotation">the</span> <span class="code_annotation">function</span>
                                dd <span class="code_number">0</span>

                UserLookupTable<span class="code_symbol">:</span>
                                dd MessageBoxALookup<span class="code_symbol">-</span>IMAGE_BASE
                                dd <span class="code_number">0</span>
                UserAddressTable<span class="code_symbol">:</span>
                MessageBoxA     dd MessageBoxALookup<span class="code_symbol">-</span>IMAGE_BASE <span class="code_annotation">;</span> <span class="code_annotation">this</span> <span class="code_annotation">is</span> <span class="code_annotation">going</span> <span class="code_annotation">to</span> <span class="code_annotation">be</span> <span class="code_annotation">replaced</span> <span class="code_annotation">with</span> <span class="code_annotation">the</span> <span class="code_annotation">address</span> <span class="code_annotation">of</span> <span class="code_annotation">the</span> <span class="code_annotation">function</span>
                                dd <span class="code_number">0</span>

                                align <span class="code_number">2</span>
                ExitProcessLookup<span class="code_symbol">:</span>
                        .Hint   dw <span class="code_number">0</span>
                        .Name   db <span class="code_string">'ExitProcess'</span><span class="code_symbol">,</span><span class="code_number">0</span>
                                align <span class="code_number">2</span>
                MessageBoxALookup<span class="code_symbol">:</span>
                        .Hint   dw <span class="code_number">0</span>
                        .Name   db <span class="code_string">'MessageBoxA'</span><span class="code_symbol">,</span><span class="code_number">0</span>

                KernelDLLName   db <span class="code_string">'KERNEL32.DLL'</span><span class="code_symbol">,</span><span class="code_number">0</span>
                UserDLLName     db <span class="code_string">'USER32.DLL'</span><span class="code_symbol">,</span><span class="code_number">0</span>

        ImportTable.End<span class="code_symbol">:</span>

        CaptionString db <span class="code_string">"PE</span> <span class="code_string">tutorial"</span><span class="code_symbol">,</span><span class="code_number">0</span>
        MessageString db <span class="code_string">"I</span> <span class="code_string">am</span> <span class="code_string">alive</span> <span class="code_string">and</span> <span class="code_string">well!"</span><span class="code_symbol">,</span><span class="code_number">0</span>    </pre></div>Before we move on to learn about some other tables defined in the optional header, we may automate this set of definitions as well. Everything between RvaAndSizes and SectionTable labels can be replaced with the following construction:
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>iterate name<span class="code_symbol">,</span>  Export<span class="code_symbol">,</span> Import<span class="code_symbol">,</span> Resource<span class="code_symbol">,</span> Exception<span class="code_symbol">,</span> Certificate<span class="code_symbol">,</span> BaseRelocation<span class="code_symbol">,</span> Debug<span class="code_symbol">,</span> Architecture<span class="code_symbol">,</span> GlobalPtr<span class="code_symbol">,</span> TLS<span class="code_symbol">,</span> LoadConfig<span class="code_symbol">,</span> BoundImport<span class="code_symbol">,</span> IAT<span class="code_symbol">,</span> DelayImport<span class="code_symbol">,</span> COMPlus<span class="code_symbol">,</span> Reserved
        if defined name<span class="code_symbol">#</span>Table
                .name.Rva               dd name<span class="code_symbol">#</span>Table<span class="code_symbol">-</span>IMAGE_BASE
                .name.Size              dd name<span class="code_symbol">#</span>Table.End<span class="code_symbol">-</span>name<span class="code_symbol">#</span>Table
        else
                .name.Rva               dd <span class="code_number">0</span>
                .name.Size              dd <span class="code_number">0</span>
        end if
end iterate    </pre></div>ITERATE assembles a block as many times as there are items on the list, substituting the text of a consecutive item for a name given in the first argument (the items start from the second one). Inside it is tested whether a symbol with a name like ExportTable or ImportTable is defined anywhere and only in such case the fields are filled. At the moment we only have ImportTable present, but as a soon as we add another one of the listed, the optional header is going to contain the right values to make it work.
<br>

<br>
A variant of the first source that has all these improvements is in the attached "basic_template.asm" file. We are going to use it as a base for the continued experiments.</div>

<div class="signature"></div><span class="smalltext"></span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row1"><a href="https://board.flatassembler.net/topic.php?p=205424#205424"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  04 Aug 2018, 23:44</span></td>
                <td valign="middle" class="row1">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205424"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row2">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row2">
                  <a name="205472"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">08 Aug 2018, 09:00</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title="Portable Executable - Adding relocations"><strong style="font-weight: bold">1.2  Adding relocations</strong>
<br>

<br>
As we have seen in the first sample, a PE image has a chosen base address at which it is constructed. The headers and additional tables of PE format are not really affected by this choice - whenever they point to something they do it through a relative address (RVA), which is independent of the selection of base. But the instructions of the program use the actual addresses and therefore they require the image to be loaded exactly where expected.
<br>

<br>
Nevertheless, the operating system may need or want to load the image at a different base. The address may be unavailable for some reason (though this should not happen when the recommended base has been used). When the PE file is a DLL loaded into memory of a process, its chosen address may already be occupied by another image (either the main program or a different library). Furthermore, with ASLR (Address space layout randomization), the system may prefer to load image at a random address as a security precaution.
<br>

<br>
In all these cases the loader needs a way to adjust the instructions of the program so that they refer to the correct addresses. The image may provide information how to do it, in form of a relocation table.
<br>

<br>
Before we learn how to construct such table, we should take a look at what needs to be adjusted when the base address can change. We are going to use the instruction of fasmg called ELEMENT, which defines a special kind of symbol that can be used like an address, but does not have a fixed value.
<br>

<br>
Let us experiment with the previously prepared template and expand the couple of lines that set up the base address.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>DEFAULT_IMAGE_BASE <span class="code_symbol">:=</span> <span class="code_number">0x400000</span>
element BASE_RELOCATION
IMAGE_BASE <span class="code_symbol">:=</span> DEFAULT_IMAGE_BASE <span class="code_symbol">+</span> BASE_RELOCATION
org IMAGE_BASE    </pre></div>With this modification, IMAGE_BASE now contains a variable term (called BASE_RELOCATION) and thanks to ORG all the labels referring to memory are going to have it, too.
<br>

<br>
We should now try to assemble it. The assembly is not going to succeed, but the errors we get may give us hints at what to do next.
<br>

<br>
The first error points to ALIGN macro. Obviously, when the value of $ is an address than contains a variable term, the assembler is not able to evaluate the expression that computes the distance to the next aligned address. We can get around it with a simple modification to the macro.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro align? pow2<span class="code_symbol">*,</span>value<span class="code_symbol">:</span>?
        if $ relativeto BASE_RELOCATION
                db <span class="code_symbol">(</span>BASE_RELOCATION<span class="code_symbol">-</span>$<span class="code_symbol">)</span>and<span class="code_symbol">(</span>pow2<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span> dup value
        else
                db <span class="code_symbol">(-</span>$<span class="code_symbol">)</span>and<span class="code_symbol">(</span>pow2<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span> dup value
        end if
end macro    </pre></div>With help of RELATIVETO operator we detect whether the $ is an address with this variable and then we compute the same expression but with BASE_RELOCATION subtracted from $. According to the specification, the address of an image should always be a multiple of 65536. Therefore the addresses aligned to any power of two up to that number should stay aligned when the base is moved.
<br>

<br>
To keep the macro simple, we have not been making it verify whether the received number is really a power of two. Therefore we are also not making it check if the number is not larger than 65536 when the address has a variable base, but we should keep this restriction in mind. After gaining more experience with fasmg it should be easy to come back to this macro and make it more resistant to misuse.
<br>

<br>
We got rid of the errors caused by ALIGN, the next one we should see is the declaration of ImageBase. It requires a really simple correction, this field should actually have the value of our default base:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .ImageBase                      dd DEFAULT_IMAGE_BASE    </pre></div>
<br>
The other fields in headers do not cause any errors. When an RVA is computed, it is a difference between an address in memory and IMAGE_BASE. Both these values contain the same variable term (BASE_RELOCATION), so subtracting one from the other results in just a plain number and everything works out.
<br>

<br>
At this moment the only remaining errors in the assembly are going to be caused by the program instructions. And this is where we get to the core of the problem.
<br>

<br>
The error message may look like this:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>flat assembler  version g.i97rp
test.asm <span class="code_symbol">[</span><span class="code_number">163</span><span class="code_symbol">]:</span>
        push CaptionString
macro push <span class="code_symbol">[</span><span class="code_number">1</span><span class="code_symbol">]</span> macro push_instruction <span class="code_symbol">[</span><span class="code_number">52</span><span class="code_symbol">]:</span>
        dd @src.imm
Processed<span class="code_symbol">:</span> dd @src.imm
Error<span class="code_symbol">:</span> variable term used where not expected.    </pre></div>PUSH is implemented as a macro, and we can see that internally it uses DD to put a 32-bit value somewhere inside the generated instruction code. It fails because of the variable term we introduced, so that value is certainly an address.
<br>

<br>
We already know that we can override the instructions of the assembler with macros. It should be possible to replace DD so that it could deal with the problem somehow.
<br>

<br>
When DD receives a movable value, we can subtract BASE_RELOCATION and obtain a plain number. This result would be a correct address as long as the image was loaded at its default base. We are going to store this address in the code of an instruction as usual, but we also need to let the loader know that if the base address is different, this value should be adjusted accordingly.
<br>

<br>
To generate this kind of information, we are going to collect the relative addresses of all values generated with DD that need to be corrected when the base is moved.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro dd? data<span class="code_symbol">&amp;</span>
        iterate unit<span class="code_symbol">,</span> data
                match ?<span class="code_symbol">,</span> unit
                        dd ?
                else if unit relativeto BASE_RELOCATION
                        repeat <span class="code_number">1</span><span class="code_symbol">,</span> i<span class="code_symbol">:</span>FIXUP_INDEX
                                FIXUP_RVA_<span class="code_symbol">#</span>i <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> IMAGE_BASE
                        end repeat
                        FIXUP_INDEX <span class="code_symbol">=</span> FIXUP_INDEX <span class="code_symbol">+</span> <span class="code_number">1</span>
                        dd unit<span class="code_symbol">-</span>BASE_RELOCATION
                else
                        dd unit
                end if
        end iterate
end macro    </pre></div>The outer layers of this macro are dedicated to handling the syntax of DD. The only argument to the macro is modified with an ampersand to signalize that it should catch everything that follows DD instruction. This may contain multiple values separated with commas, so we then iterate through all of them. We need to be able to handle a question mark in place of a value, so we detect it with MATCH (which is like a special form of IF, at least in this situation).
<br>

<br>
When the unit of data is a movable address, we subtract BASE_RELOCATION from the value before passing it to the original DD. But before doing that, we collect the relative address of this place in code and store it in a numbered constant.
<br>

<br>
The variable that we use to count the constants needs to be initialized first. And at the end of source we are going to put the final number of collected addresses into yet another constant:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>FIXUP_INDEX <span class="code_symbol">=</span> <span class="code_number">0</span>

postpone
        FIXUP_COUNT <span class="code_symbol">:=</span> FIXUP_INDEX
end postpone    </pre></div>We have the information gathered, now we need to put it in a form that the loader can understand.
<br>

<br>
First, we should add another section specifically for this data. The macros that we prepared earlier make it easy.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section <span class="code_string">'.reloc'</span><span class="code_symbol">,</span> IMAGE_SCN_MEM_READ <span class="code_symbol">+</span> IMAGE_SCN_MEM_DISCARDABLE    </pre></div>We used a new attribute, one that describes the section as discardable. After the loader uses the information to adjust the code to the new address of residence, the content of this section is no longer going to be needed.
<br>

<br>
Now the most important part, the actual table defining all the places in code that require adjustments. We need to begin it with BaseRelocationTable label so that it becomes included in the right place in the optional header.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        BaseRelocationTable<span class="code_symbol">:</span>

                FIRST <span class="code_symbol">=</span> <span class="code_number">0</span>
                BASE <span class="code_symbol">=</span> <span class="code_number">0</span>
                repeat FIXUP_COUNT<span class="code_symbol">+</span><span class="code_number">1</span><span class="code_symbol">,</span> INDEX<span class="code_symbol">:</span><span class="code_number">0</span>
                        if INDEX <span class="code_symbol">=</span> FIXUP_COUNT <span class="code_symbol">|</span> FIXUP_RVA_<span class="code_symbol">#</span>INDEX and not <span class="code_number">0xFFF</span> <span class="code_symbol">&lt;&gt;</span> BASE and not <span class="code_number">0xFFF</span>
                                if INDEX <span class="code_symbol">=</span> FIXUP_COUNT <span class="code_symbol">|</span> INDEX <span class="code_symbol">&gt;</span> FIRST
                                        ALIGNMENT <span class="code_symbol">=</span> <span class="code_symbol">(</span>INDEX<span class="code_symbol">-</span>FIRST<span class="code_symbol">)</span> and <span class="code_number">1</span>
                                        dd BASE
                                        dd <span class="code_number">8</span><span class="code_symbol">+(</span>INDEX<span class="code_symbol">-</span>FIRST<span class="code_symbol">+</span>ALIGNMENT<span class="code_symbol">)*</span><span class="code_number">2</span>
                                        repeat <span class="code_symbol">(</span>INDEX<span class="code_symbol">-</span>FIRST<span class="code_symbol">),</span> i<span class="code_symbol">:</span>FIRST
                                                dw FIXUP_RVA_<span class="code_symbol">#</span>i and <span class="code_number">0xFFF</span> <span class="code_symbol">+</span> IMAGE_REL_BASED_HIGHLOW shl <span class="code_number">12</span>
                                        end repeat
                                        if ALIGNMENT
                                                dw <span class="code_number">0</span>
                                        end if
                                end if
                                if INDEX <span class="code_symbol">&lt;</span> FIXUP_COUNT
                                        FIRST <span class="code_symbol">=</span> INDEX
                                        BASE <span class="code_symbol">=</span> FIXUP_RVA_<span class="code_symbol">#</span>INDEX and not <span class="code_number">0xFFF</span>
                                end if
                        end if
                end repeat

        BaseRelocationTable.End<span class="code_symbol">:</span>    </pre></div>The base relocation table is divided into blocks, each one contaning entries corresponding to addresses within a single 4096-byte page. This allows to pack the entries tightly. The upper part of the address is common to all the entries in the block and is stored in one place before them. The individual addresses stored within a block differ only in the low part and it suffices to store the bottom 12 bits of each one.
<br>

<br>
To generate such structure, we iterate through all the collected values and wait until the upper part of the address differs from the previous one stored in BASE variable. When this happens, we make a block with all the addresses that had common upper part up to this point, set up FIRST to be the number of the first address for the next block and update BASE with the new value.
<br>

<br>
We perform one additional iteration, to make the last block. This is why the conditions contain additional clauses to check if it is a final round and the block is then forcibly generated.
<br>

<br>
Each block starts with two 32-bit values, first is the base address for all entries (with the low 12 bits cleared), second is the total length of the block. Every entry that follows is 2 bytes long, but the length of a block needs to be a multiple of 4, so if the number of entries is odd, we need to add a dummy entry at the end. To do this, we define ALIGNMENT by taking the lowest bit of the number of entries, so it is 1 when there is an odd number of entries and 0 otherwise.
<br>

<br>
An entry inside a block is a 16-bit value, with the low 12 bits being the bottom part of the address, and the upper bits containing a description of a method that should be used to adjust the code at that address. The dummy entries have these bits zeroed and it corresponds to a "do nothing" method. In the regular entries we universally choose IMAGE_REL_BASED_HIGHLOW. This makes the loader adjust a 32-bit value in code by adding to it the difference between the new base address and the default one. It is exactly what we need to correct the values generated by our DD macro.
<br>

<br>
If this seems a bit complex, it might be a good idea to use our "listing.inc" and look at what is generated by this part of the source:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre><span class="code_symbol">[</span><span class="code_number">0000000000403000</span><span class="code_symbol">]</span>                                    BaseRelocationTable<span class="code_symbol">:</span>
<span class="code_symbol">[</span><span class="code_number">0000000000403000</span><span class="code_symbol">]</span>                                    FIRST <span class="code_symbol">=</span> <span class="code_number">0</span>
<span class="code_symbol">[</span><span class="code_number">0000000000403000</span><span class="code_symbol">]</span>                                    BASE <span class="code_symbol">=</span> <span class="code_number">0</span>
<span class="code_symbol">[</span><span class="code_number">0000000000403000</span><span class="code_symbol">]</span>                                    FIRST <span class="code_symbol">=</span> <span class="code_number">0</span>
<span class="code_symbol">[</span><span class="code_number">0000000000403000</span><span class="code_symbol">]</span>                                    BASE <span class="code_symbol">=</span> FIXUP_RVA_<span class="code_symbol">#</span><span class="code_number">0</span> and not <span class="code_number">0xFFF</span>
<span class="code_symbol">[</span><span class="code_number">0000000000403000</span><span class="code_symbol">]</span>                                    ALIGNMENT <span class="code_symbol">=</span> <span class="code_symbol">(</span><span class="code_number">4</span><span class="code_symbol">-</span>FIRST<span class="code_symbol">)</span> and <span class="code_number">1</span>
<span class="code_symbol">[</span><span class="code_number">0000000000403000</span><span class="code_symbol">]</span> <span class="code_number">00000600</span><span class="code_symbol">:</span> <span class="code_number">00</span> <span class="code_number">10</span> <span class="code_number">00</span> <span class="code_number">00</span>              dd BASE
<span class="code_symbol">[</span><span class="code_number">0000000000403004</span><span class="code_symbol">]</span> <span class="code_number">00000604</span><span class="code_symbol">:</span> <span class="code_number">10</span> <span class="code_number">00</span> <span class="code_number">00</span> <span class="code_number">00</span>              dd <span class="code_number">8</span><span class="code_symbol">+(</span><span class="code_number">4</span><span class="code_symbol">-</span>FIRST<span class="code_symbol">+</span>ALIGNMENT<span class="code_symbol">)*</span><span class="code_number">2</span>
<span class="code_symbol">[</span><span class="code_number">0000000000403008</span><span class="code_symbol">]</span> <span class="code_number">00000608</span><span class="code_symbol">:</span> <span class="code_number">03</span> <span class="code_number">30</span>                    dw FIXUP_RVA_<span class="code_symbol">#</span><span class="code_number">0</span> and <span class="code_number">0xFFF</span> <span class="code_symbol">+</span> IMAGE_REL_BASED_HIGHLOW shl <span class="code_number">12</span>
<span class="code_symbol">[</span><span class="code_number">000000000040300A</span><span class="code_symbol">]</span> <span class="code_number">0000060A</span><span class="code_symbol">:</span> <span class="code_number">08</span> <span class="code_number">30</span>                    dw FIXUP_RVA_<span class="code_symbol">#</span><span class="code_number">1</span> and <span class="code_number">0xFFF</span> <span class="code_symbol">+</span> IMAGE_REL_BASED_HIGHLOW shl <span class="code_number">12</span>
<span class="code_symbol">[</span><span class="code_number">000000000040300C</span><span class="code_symbol">]</span> <span class="code_number">0000060C</span><span class="code_symbol">:</span> <span class="code_number">10</span> <span class="code_number">30</span>                    dw FIXUP_RVA_<span class="code_symbol">#</span><span class="code_number">2</span> and <span class="code_number">0xFFF</span> <span class="code_symbol">+</span> IMAGE_REL_BASED_HIGHLOW shl <span class="code_number">12</span>
<span class="code_symbol">[</span><span class="code_number">000000000040300E</span><span class="code_symbol">]</span> <span class="code_number">0000060E</span><span class="code_symbol">:</span> <span class="code_number">18</span> <span class="code_number">30</span>                    dw FIXUP_RVA_<span class="code_symbol">#</span><span class="code_number">3</span> and <span class="code_number">0xFFF</span> <span class="code_symbol">+</span> IMAGE_REL_BASED_HIGHLOW shl <span class="code_number">12</span>
<span class="code_symbol">[</span><span class="code_number">0000000000403010</span><span class="code_symbol">]</span>                                    BaseRelocationTable.End<span class="code_symbol">:</span>    </pre></div>
<br>
Now the base relocation table is there for the loader to use, but we should also explicitly state that our executable does not mind being loaded at an address different from default. We do this by adding IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE to DllCharacteristics.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .DllCharacteristics             dw IMAGE_DLLCHARACTERISTICS_NX_COMPAT <span class="code_symbol">+</span> IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE    </pre></div>With this bit set, the image can participate in ASLR when the system supports it.
<br>

<br>
But how do we know that this worked? When we assemble such modified example and run it, it is going to display the same message as always, we do not know if it was loaded at the default base or some other address.
<br>

<br>
There is a simple method to ensure that the relocations are used. Windows cannot load an image at the address zero, this area is reserved by the system. If we generate PE file with such default base, the loader will not have a choice but to relocate. Therefore if we change DEFAULT_IMAGE_BASE to zero and the program keeps running as usual, we can treat it as a proof that the relocations function correctly.</div>

<div class="signature"></div><span class="smalltext"></span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row2"><a href="https://board.flatassembler.net/topic.php?p=205472#205472"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  08 Aug 2018, 09:00</span></td>
                <td valign="middle" class="row2">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205472"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row1">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row1">
                  <a name="205473"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">08 Aug 2018, 09:03</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title="Portable Executable - Making a library"><strong style="font-weight: bold">1.3  Making a library</strong>
<br>

<br>
We already know how to import functions from a DLL, now it is time to make our own one. The relocatable image that we have just prepared should be our starting point. It is easy for libraries to have clashing addresses, even if we try to come up with a unique one, therefore having a relocation table is practically mandatory.
<br>

<br>
What distinguishes a DLL is a single bit in Characteristics, with a self-explanatory name:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .Characteristics                dw IMAGE_FILE_32BIT_MACHINE <span class="code_symbol">+</span> IMAGE_FILE_EXECUTABLE_IMAGE <span class="code_symbol">+</span> IMAGE_FILE_DLL    </pre></div>But for our library to be of some use, we should make it contain some function that a program can then import and call.
<br>

<br>
Let us rewrite the '.text' section then.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section <span class="code_string">'.text'</span><span class="code_symbol">,</span> IMAGE_SCN_MEM_EXECUTE <span class="code_symbol">+</span> IMAGE_SCN_MEM_READ

        EntryPoint<span class="code_symbol">:</span>
                mov     eax<span class="code_symbol">,</span><span class="code_number">1</span>
                ret     <span class="code_number">12</span>
    </pre></div>The entry point of a DLL is a function itself, always called when a library has just been loaded, but also in few other situations. This function should return TRUE to indicate a success and this is done by loading 1 into the register EAX. We end the function with RET, but we also have to use its optional argument to clean 12 bytes off the stack. In 32-bit Windows the standard calling convention requires that the function cleans up the stack upon returning. The entry point function of a DLL takes three parameters, each of them is 32-bit and thus occupies 4 bytes, this gives the total of 12 bytes.
<br>

<br>
What comes next is the function that we are going to export.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        ShowOff<span class="code_symbol">:</span>
                push    <span class="code_number">0</span>
                push    CaptionString
                push    MessageString
                push    <span class="code_number">0</span>
                call    <span class="code_symbol">[</span>MessageBoxA<span class="code_symbol">]</span>
                ret    </pre></div>It does not take any parameters, does the same thing that all our previous examples did and then returns.
<br>

<br>
The function is ready, but now we need to construct an export table for our DLL. We can put in it the '.rdata' section, just like the import table, we only need to make sure that the starting address is aligned. A table that lies right at the start of the section inherits a nice alignment, but when we put one on top of another data, we should better use ALIGN to keep the address round enough.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        align <span class="code_number">4</span>

        ExportTable<span class="code_symbol">:</span>

                .ExportFlags            dd <span class="code_number">0</span>
                .TimeDateStamp          dd %t
                .MajorVersion           dw <span class="code_number">0</span>
                .MinorVersion           dw <span class="code_number">0</span>
                .NameRva                dd LibraryName<span class="code_symbol">-</span>IMAGE_BASE
                .OrdinalBase            dd <span class="code_number">1</span>
                .AddressTableEntries    dd <span class="code_number">1</span>
                .NumberOfNamePointers   dd <span class="code_number">1</span>
                .ExportAddressTableRva  dd ExportAddressTable<span class="code_symbol">-</span>IMAGE_BASE
                .NamePointerRva         dd ExportNamePointerTable<span class="code_symbol">-</span>IMAGE_BASE
                .OrdinalTableRva        dd ExportOrdinalTable<span class="code_symbol">-</span>IMAGE_BASE
    </pre></div>The initial part is the Export Directory Table, which always contains just one record, as it exports function of a just a single library.
<br>

<br>
ExportFlags is an unused field and should always be zero. TimeDateStamp is the value used to verify whether the bound imports refer to the same version the library, as mentioned earlier. Nowadays ASLR makes bound imports mostly obsolete and we are not going to use them, but we put a good timestamp there just in case someone wanted to try binding to our library.
<br>

<br>
MajorVersion and MinorVersion we can set to any values we wish, they are mostly irrelevant.
<br>

<br>
NameRva points the name of the library, a string that we are going to define near the end of the table to not mess up the alignment.
<br>

<br>
To understand the purpose of OrdinalBase we need to discuss one thing about the import table that got omitted earlier. It possible to specify a function to import not by the name, but by an ordinal number which identifies a record within the Export Address Table. The addresses (and therefore the functions they point to) are numbered starting from the value of OrdinalBase. A usual choice of this offset is 1, then the first address in the table has ordinal 1, the second one - ordinal 2, and so on.
<br>

<br>
An entry in Import Lookup Table that would normally contain an RVA may be marked as containing an ordinal number by having the highest bit set. Its value is then 0x8000000 plus the ordinal of a function to import. However, this is a discouraged method. Different versions of a library may not have the same numbering of the functions unless someone paid a close attention to it. Therefore we are not going to use this technique and the value of OrdinalBase has no other uses.
<br>

<br>
AddressTableEntries gives the number of addresses in EAT, which has a relative address specified in ExportAddressTableRva.
<br>

<br>
NumberOfNamePointers defines the number of entries in two other tables, pointed to by NamePointerRva and OrdinalTableRva. These tables run in parallel, the records of the first one point to the names of the functions while the second one defines corresponding indexes in EAT. The latter are 16-bit numbers that count the records in EAT starting from zero and do not depend on the contents of OrdinalBase.
<br>

<br>
EAT can have a different length than the other two tables. It is possible to have addresses that have no associated name and such functions could be imported only through their ordinal numbers. On the other hand it is also possible to have multiple names pointing to the same entry in EAT so a single function can have several aliases.
<br>

<br>
In this example we define just one function with one name, thus we put 1 everywhere.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                ExportAddressTable<span class="code_symbol">:</span>
                                        dd ShowOff<span class="code_symbol">-</span>IMAGE_BASE
    </pre></div>The entry in EAT is the relative address of the exported function. This seems pretty straightforward, but there is a small subtlety hidden here. The address is treated as pointing directly to a function as long as it does not lie within the boundaries of the export table (in our case between ExportTable and ExportTable.End labels), otherwise it would be interpreted as the address of a string describing the function in another library. This is how the forwarded exports can be made. However in this example we just export our own function.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                ExportNamePointerTable<span class="code_symbol">:</span>
                                        dd ShowOff.Name<span class="code_symbol">-</span>IMAGE_BASE

                ExportOrdinalTable<span class="code_symbol">:</span>
                                        dw <span class="code_number">0</span>
    </pre></div>The parallel tables connect the addresses of strings with the indexes into EAT. The addresses are counted from zero so this is the number we need to associate with the exported name of our only function. The names in the table need to be ordered lexically (to allow an efficient binary search) but when we have just one this is not an issue.
<br>

<br>
All that remains is to define the needed strings, at this point we no longer have to worry about them causing any misalignment.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                LibraryName db <span class="code_string">'LIBRARY.DLL'</span><span class="code_symbol">,</span><span class="code_number">0</span>
                ShowOff.Name db <span class="code_string">'ShowOff'</span><span class="code_symbol">,</span><span class="code_number">0</span>

        ExportTable.End<span class="code_symbol">:</span>    </pre></div>The export table is therefore complete and our library should be ready to use. As a final touch, we may alter the message that would be shown by the function, so when we see it during testing we should know that it really comes from this freshly made DLL:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        MessageString db <span class="code_string">"This</span> <span class="code_string">is</span> <span class="code_string">a</span> <span class="code_string">message</span> <span class="code_string">from</span> <span class="code_string">the</span> <span class="code_string">depth</span> <span class="code_string">of</span> <span class="code_string">the</span> <span class="code_string">library."</span><span class="code_symbol">,</span><span class="code_number">0</span>    </pre></div>
<br>

<br>
But to test the library, we also need to make a program that uses it. We should once more copy our template and modify the contents of the '.text' section to make it call the function from our DLL:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        EntryPoint<span class="code_symbol">:</span>

                call    <span class="code_symbol">[</span>ShowOff<span class="code_symbol">]</span>

                push    <span class="code_number">0</span>
                call    <span class="code_symbol">[</span>ExitProcess<span class="code_symbol">]</span>
    </pre></div>Of course we also need to modify the import table to have this function actually available. This should be easy now that we know what goes where, but doing it manually can quickly become a dull task (even if it might be a good exercise at first). We should make a little investment and prepare a macro that would do most of the boring things for us.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro import? items<span class="code_symbol">&amp;</span>

        align <span class="code_number">4</span>

        ImportTable<span class="code_symbol">:</span>

        iterate item<span class="code_symbol">,</span> items
                match name.<span class="code_symbol">=</span>DLL?<span class="code_symbol">,</span> item
                        .name.ImportLookupTableRva      dd ImportLookupTable.name<span class="code_symbol">-</span>IMAGE_BASE
                        .name.TimeDateStamp             dd <span class="code_number">0</span>
                        .name.ForwarderChain            dd <span class="code_number">0</span>
                        .name.NameRva                   dd ImportLibraryName.name<span class="code_symbol">-</span>IMAGE_BASE
                        .name.ImportAddressTableRva     dd ImportAddressTable.name<span class="code_symbol">-</span>IMAGE_BASE
                else if % <span class="code_symbol">=</span> <span class="code_number">1</span>
                        err <span class="code_string">'please</span> <span class="code_string">start</span> <span class="code_string">with</span> <span class="code_string">a</span> <span class="code_string">name</span> <span class="code_string">of</span> <span class="code_string">a</span> <span class="code_string">DLL'</span>
                end if
        end iterate
                                                        dd <span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span>

        iterate item<span class="code_symbol">,</span> items
                match name.<span class="code_symbol">=</span>DLL?<span class="code_symbol">,</span> item
                                                        dd <span class="code_number">0</span>
                        ImportLookupTable.name<span class="code_symbol">:</span>
                else
                                                        dd ImportLookup.item<span class="code_symbol">-</span>IMAGE_BASE
                end match
        end iterate

        iterate item<span class="code_symbol">,</span> items
                match name.<span class="code_symbol">=</span>DLL?<span class="code_symbol">,</span> item
                                                        dd <span class="code_number">0</span>
                        ImportAddressTable.name<span class="code_symbol">:</span>
                else
                                item                    dd ImportLookup.item<span class="code_symbol">-</span>IMAGE_BASE
                end match
        end iterate
                                                        dd <span class="code_number">0</span>

        iterate item<span class="code_symbol">,</span> items
                match name.<span class="code_symbol">=</span>DLL?<span class="code_symbol">,</span> item
                        ImportLibraryName.name          db <span class="code_symbol">`</span>item<span class="code_symbol">,</span><span class="code_number">0</span>
                else
                                                        align <span class="code_number">2</span>
                        ImportLookup.item<span class="code_symbol">:</span>
                                                        dw <span class="code_number">0</span>
                                                        db <span class="code_symbol">`</span>item<span class="code_symbol">,</span><span class="code_number">0</span>
                end match
        end iterate

        ImportTable.End<span class="code_symbol">:</span>

end macro    </pre></div>This macro interates multiple times through a list of items and it uses MATCH to distinguish two kinds of them. If one ends with ".DLL" it is taken as a name of a library to import, other items are the names of functions belonging to a DLL specified just before them.
<br>

<br>
A few new tricks have been used here. When a pattern given to MATCH contains a name that is not preceded by equality sign, it is a wildcard matching any non-empty text. Moreover, that name is then replaced with the corresponding text everywhere inside the MATCH block. In this case "name" becomes a parameter containing the name of the library without the extension. The "dll" text is matched literally because of the equality sign, though the trailing question mark makes this a case-insensitive requirement.
<br>

<br>
The macro should not allow function names to be given without a library being defined first, so if the initial item does match the pattern, an error is signalled. The number of processed item is taken from the special counter %, which is available in any repeating block.
<br>

<br>
The first loop looks only at the names of the libraries and defines Import Directory Table with records for each one of them. The table should end with five zeroed fields, but it only makes four of them. This is a little tricky - in the following loops every time a new ILT or IAT is started, it generates a zeroed field to close the previous one. The very first time it happens, that zero becomes the missing fifth one to complete the Import Directory Table.
<br>

<br>
When it comes to defining the names of libraries and function, the backquote is used to make the text of a parameter into a string.
<br>

<br>
The internal workings of the macro are normally hidden when we generate listing, but there is a way to prioritize the expansion of the macro and make the lines it generates show up. An exclamation mark after the name gives macro such priority:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro import?! items<span class="code_symbol">&amp;</span>    </pre></div>This is a trick to keep in mind for whenever a more detailed listing might be helpful.
<br>

<br>
With the assistance of the macro we can now define an entire '.rdata' section for our testing program in a just a couple of lines:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section <span class="code_string">'.rdata'</span><span class="code_symbol">,</span> IMAGE_SCN_MEM_READ

        import LIBRARY.DLL<span class="code_symbol">,</span> ShowOff<span class="code_symbol">,</span> <span class="code_symbol">\</span>
               KERNEL32.DLL<span class="code_symbol">,</span> ExitProcess    </pre></div>The backslash character is used to break a single line into multiple ones, solely for readability.
<br>

<br>
We can now assemble the program and the library, keeping in mind that the latter should be written into a file named "library.dll". The attached files "library.asm" and "library_user.asm" contain sources prepared according to the above process.
<br>

<br>
If we keep experimenting, we might want to create libraries with more functions. This is a good excuse to create another macro, we should not have to concern ourselves with manual creation of the export tables.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro export? library<span class="code_symbol">*,</span>functions<span class="code_symbol">&amp;</span>

        align <span class="code_number">4</span>

        iterate name<span class="code_symbol">,</span> functions
                EXPORT_ADDRESS.% <span class="code_symbol">:=</span> name<span class="code_symbol">-</span>IMAGE_BASE
                EXPORT_NAME.% <span class="code_symbol">=</span> <span class="code_symbol">`</span>name
                EXPORT_ORDINAL.% <span class="code_symbol">=</span> %<span class="code_symbol">-</span><span class="code_number">1</span>
                EXPORT_COUNT <span class="code_symbol">=</span> %%
        end iterate    </pre></div>A syntax for this macro should be analogous to the one we have for imports. In this case there is just one library to talk about, so the name of the DLL comes as the first argument and all that follows are the names of the functions.
<br>

<br>
We define a numbered constants with values that should go into appropriate sub-tables. We need them in this form, because we may have to shuffle some around, remembering that the table of names must have them ordered lexically.
<br>

<br>
We also define EXPORT_COUNT value using a special symbol %%, which is a companion to % and is the total number of repetitions. The same definition is redone with every iteration, but this is quite harmless. Actually, that %% could be replaced with % to the same effect, as only the last assigned value counts.
<br>

<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        D <span class="code_symbol">=</span> EXPORT_COUNT
        while D <span class="code_symbol">&gt;</span> <span class="code_number">1</span>
                D <span class="code_symbol">=</span> D shr <span class="code_number">1</span>
                repeat EXPORT_COUNT<span class="code_symbol">-</span>D
                        X <span class="code_symbol">=</span> D<span class="code_symbol">+</span>%
                        while X<span class="code_symbol">-</span>D <span class="code_symbol">&gt;</span> <span class="code_number">0</span>
                                repeat <span class="code_number">1</span><span class="code_symbol">,</span> i<span class="code_symbol">:</span>X<span class="code_symbol">-</span>D<span class="code_symbol">,</span> j<span class="code_symbol">:</span>X
                                        if lengthof EXPORT_NAME.i <span class="code_symbol">&gt;</span> lengthof EXPORT_NAME.j
                                                S <span class="code_symbol">=</span> lengthof EXPORT_NAME.i
                                        else
                                                S <span class="code_symbol">=</span> lengthof EXPORT_NAME.j
                                        end if
                                        if EXPORT_NAME.i bswap S <span class="code_symbol">&gt;</span> EXPORT_NAME.j bswap S
                                                T <span class="code_symbol">=</span> EXPORT_NAME.i
                                                EXPORT_NAME.i <span class="code_symbol">=</span> EXPORT_NAME.j
                                                EXPORT_NAME.j <span class="code_symbol">=</span> T
                                                T <span class="code_symbol">=</span> EXPORT_ORDINAL.i
                                                EXPORT_ORDINAL.i <span class="code_symbol">=</span> EXPORT_ORDINAL.j
                                                EXPORT_ORDINAL.j <span class="code_symbol">=</span> T
                                        else
                                                break
                                        end if
                                end repeat
                                X <span class="code_symbol">=</span> X<span class="code_symbol">-</span>D
                        end while
                end repeat
        end while    </pre></div>This portion of the macro performs a classic binary Shell sort algorithm to order the list of names. If the functions given to the macro are already in lexical order, this block does nothing. 
<br>

<br>
While the outer layers should more or less speak for themselves, the interior is a bit convoluted because of the peculiarities of the language. The innermost REPEAT is not a real loop but an idiomatic expression that we have already seen before. It makes a text substitution that replaces "i" and "j" with numbers computed from associated expressions.
<br>

<br>
The assembler performs comparisons numerically and the strings are converted into numbers using the little-endian encoding - the first byte of the text is the least significant byte of the number. Therefore to compare texts lexically we need to reverse the order of bytes in corresponding numbers and this is done with BSWAP. The size of the reversed numeric data should be the same for both strings, because then compared values have the same position of the most significant byte (which contains what was the first byte of the text). The greater of the two lengths becomes the chosen size, since the numbers must be large enough to contain the strings.
<br>

<br>
When the list of names has some of its values swapped during the sorting, the corresponding ordinal numbers are exchanged as well, while the list of addresses remains unaltered. This way every function keeps the ordinal number it was assigned based on the order of names given to the macro.
<br>

<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        ExportTable<span class="code_symbol">:</span>

                .ExportFlags            dd <span class="code_number">0</span>
                .TimeDateStamp          dd %t
                .MajorVersion           dw <span class="code_number">0</span>
                .MinorVersion           dw <span class="code_number">0</span>
                .NameRva                dd ExportLibraryName<span class="code_symbol">-</span>IMAGE_BASE
                .OrdinalBase            dd <span class="code_number">1</span>
                .AddressTableEntries    dd EXPORT_COUNT
                .NumberOfNamePointers   dd EXPORT_COUNT
                .ExportAddressTableRva  dd ExportAddressTable<span class="code_symbol">-</span>IMAGE_BASE
                .NamePointerRva         dd ExportNamePointerTable<span class="code_symbol">-</span>IMAGE_BASE
                .OrdinalTableRva        dd ExportOrdinalTable<span class="code_symbol">-</span>IMAGE_BASE

                ExportAddressTable<span class="code_symbol">:</span>
                repeat EXPORT_COUNT
                                        dd EXPORT_ADDRESS.%
                end repeat

                ExportNamePointerTable<span class="code_symbol">:</span>
                repeat EXPORT_COUNT
                                        dd ExportName.%<span class="code_symbol">-</span>IMAGE_BASE
                end repeat

                ExportOrdinalTable<span class="code_symbol">:</span>
                repeat EXPORT_COUNT
                                        dw EXPORT_ORDINAL.%
                end repeat

                ExportLibraryName db <span class="code_symbol">`</span>library<span class="code_symbol">,</span><span class="code_number">0</span>

                repeat EXPORT_COUNT
                        ExportName.%    db EXPORT_NAME.%<span class="code_symbol">,</span><span class="code_number">0</span>
                end repeat

        ExportTable.End<span class="code_symbol">:</span>

end macro    </pre></div>Finally we build the actual tables. All the lists were constructed and sorted earlier, here they are just put into familiar structures.
<br>

<br>
With such defined macro the export table of our library could be defined simply as:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        export LIBRARY.DLL<span class="code_symbol">,</span> ShowOff    </pre></div>A source text that uses all the macros we have made so far can be found in the attached "library_template.asm".</div>

<div class="signature"></div><span class="smalltext"></span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row1"><a href="https://board.flatassembler.net/topic.php?p=205473#205473"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  08 Aug 2018, 09:03</span></td>
                <td valign="middle" class="row1">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205473"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row2">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row2">
                  <a name="205474"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">08 Aug 2018, 09:18</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title=""><strong style="font-weight: bold">1.4  Embedding resources</strong>
<br>

<br>
The resources are like a small files enclosed within the executable. They contain supplementary data of various kinds, often in formats that could just as well function in separate files.
<br>

<br>
Plain resource tables that were present in some older formats (like NE used by 16-bit Windows) in case of PE were replaced with a sorted tree structure. This allows to efficiently search for resources when needed, but it also means that we need to do a little more work to construct a resource directory in our image.
<br>

<br>
While the structure of the resource tree was designed in a way that could allow arbitrarily many levels, in practice there are always exactly three. On the initial level there are branches for different types of data, on the second level they are split according to the identifiers of individual resources. The final level allows each of the resources to have versions in different languages.
<br>

<br>
To start with a tree that is as simple as possible, we are going to define a solitary resource that does not need translations into other languages. Each level is then going to be a single list with just one entry. 
<br>

<br>
The type of resource that we are going to define first is the manifest file. This is an XML that is read by the system when it loads the image and it allows to specify various requirements that the program may have. We need to be able to immediately see the result of embedding it in our PE, therefore we are going to use this one:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre><span class="code_symbol">&lt;</span>?xml version<span class="code_symbol">=</span><span class="code_string">'1.0'</span> encoding<span class="code_symbol">=</span><span class="code_string">'UTF-8'</span> standalone<span class="code_symbol">=</span><span class="code_string">'yes'</span>?<span class="code_symbol">&gt;</span>
<span class="code_symbol">&lt;</span>assembly xmlns<span class="code_symbol">=</span><span class="code_string">'urn:schemas-microsoft-com:asm.v1'</span> manifestVersion<span class="code_symbol">=</span><span class="code_string">'1.0'</span><span class="code_symbol">&gt;</span>
  <span class="code_symbol">&lt;</span>trustInfo xmlns<span class="code_symbol">=</span><span class="code_string">"urn:schemas-microsoft-com:asm.v3"</span><span class="code_symbol">&gt;</span>
    <span class="code_symbol">&lt;</span>security<span class="code_symbol">&gt;</span>
      <span class="code_symbol">&lt;</span>requestedPrivileges<span class="code_symbol">&gt;</span>
        <span class="code_symbol">&lt;</span>requestedExecutionLevel level<span class="code_symbol">=</span><span class="code_string">'requireAdministrator'</span> uiAccess<span class="code_symbol">=</span><span class="code_string">'false'</span> <span class="code_symbol">/&gt;</span>
      <span class="code_symbol">&lt;/</span>requestedPrivileges<span class="code_symbol">&gt;</span>
    <span class="code_symbol">&lt;/</span>security<span class="code_symbol">&gt;</span>
  <span class="code_symbol">&lt;/</span>trustInfo<span class="code_symbol">&gt;</span>
<span class="code_symbol">&lt;/</span>assembly<span class="code_symbol">&gt;</span>    </pre></div>This simple manifest is going to mark our program as requiring administrative privileges, which should trigger a UAC confirmation window when we try to run it. This is going to be our immediate confirmation that the resource structures have been read and understood correctly.
<br>

<br>
The attached "manifest.xml" contains the text of this manifest, we are going to insert the contents of this file directly into our image.
<br>

<br>
We also need to include an additional header that gives names to standard resource types and identifiers:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>use <span class="code_string">'winuser.inc'</span>    </pre></div>
<br>
All the data associated with resources is usually stored in the ".rsrc" section. Thanks to our macros we can add such section to our image easily:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section <span class="code_string">'.rsrc'</span><span class="code_symbol">,</span> IMAGE_SCN_MEM_READ    </pre></div>The place is ready, now we may start writing the tables. The first one is the root of the tree, we need to label it as ResourceTable so that its address lands in the right place in the optional header.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        ResourceTable<span class="code_symbol">:</span>
                .Characteristics        dd <span class="code_number">0</span>
                .TimeDateStamp          dd <span class="code_number">0</span>
                .MajorVersion           dw <span class="code_number">0</span>
                .MinorVersion           dw <span class="code_number">0</span>
                .NumberOfNameEntries    dw <span class="code_number">0</span>
                .NumberOfIdEntries      dw <span class="code_number">1</span>

                .1.Id                   dd RT_MANIFEST
                .1.Offset               dd <span class="code_number">0x80000000</span> <span class="code_symbol">+</span> ResourceDirectory_Manifest<span class="code_symbol">-</span>ResourceTable    </pre></div>This kind of table is called a resource directory, all the subdirectories at lower level also use the same layout.
<br>

<br>
Characteristics was intended to hold some flags, but it has never been used for anything and should always be zero. 
<br>

<br>
TimeDateStamp should be the time when the resource was created by the compiler. We could put the value of %t here, but by zeroing it we can emphasize that we are not really a resource compiler and this structure is not made by one.
<br>

<br>
MajorVersion and MinorVersion as usual can be set to whatever we want.
<br>

<br>
NumberOfNameEntries and NumberOfIdEntries define how many entries are in the directory, their total number is the sum of these two values. The table that follows should list named entries first, then ones with numeric identifiers. Both sub-lists should be sorted, but in our first sample every one of them is going to contain just a single element, so we do not have to worry about the ordering.
<br>

<br>
The root directory lists the types of resources and all standard ones are identified by numbers, therefore we use only the second kind of an entry. The only element of the table points to a subdirectory containing RT_MANIFEST resources. The highest bit of Offset field indicates that this is a relative address of a subdirectory and not a data entry (this is what allows in theory to terminate the tree at any level). The offset given in the lower bits is not an RVA, but a distance from the beginning of resource table.
<br>

<br>
Next we define a subdirectory listing all the resources of this type:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        ResourceDirectory_Manifest<span class="code_symbol">:</span>
                .Characteristics        dd <span class="code_number">0</span>
                .TimeDateStamp          dd <span class="code_number">0</span>
                .MajorVersion           dw <span class="code_number">0</span>
                .MinorVersion           dw <span class="code_number">0</span>
                .NumberOfNameEntries    dw <span class="code_number">0</span>
                .NumberOfIdEntries      dw <span class="code_number">1</span>

                .1.Id                   dd CREATEPROCESS_MANIFEST_RESOURCE_ID
                .1.Offset               dd <span class="code_number">0x80000000</span> <span class="code_symbol">+</span> ResourceDirectory_Manifest_CreateProcess<span class="code_symbol">-</span>ResourceTable    </pre></div>Again, there is only one entry with numeric identifier. We use a pre-defined number that tells the system this is the manifest definining how our program should be run.
<br>

<br>
We point to another subdirectory, to reach the required three levels:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        ResourceDirectory_Manifest_CreateProcess<span class="code_symbol">:</span>
                .Characteristics        dd <span class="code_number">0</span>
                .TimeDateStamp          dd <span class="code_number">0</span>
                .MajorVersion           dw <span class="code_number">0</span>
                .MinorVersion           dw <span class="code_number">0</span>
                .NumberOfNameEntries    dw <span class="code_number">0</span>
                .NumberOfIdEntries      dw <span class="code_number">1</span>

                .1.Id                   dd <span class="code_number">0</span> <span class="code_annotation">;</span> <span class="code_annotation">LANG_NEUTRAL</span> <span class="code_annotation">+</span> <span class="code_annotation">SUBLANG_NEUTRAL</span>
                .1.Offset               dd ResourceDataEntry_Manifest_CreateProcess<span class="code_symbol">-</span>ResourceTable    </pre></div>Table on this level always has only numeric entries, because languages are identified with integers. The manifest does not need translations, so we define a single entry with zero as identifier, which means that the content is language-neutral. We do not have the related constants defined, in our samples we are not going to use values other than zero there. The possible language identifiers are listed on the <a href="https://docs.microsoft.com/en-us/windows/desktop/intl/language-identifier-constants-and-strings" target="_blank" class="postlink">Microsoft documentation pages</a>.
<br>

<br>
The highest bit of Offset is cleared, because this time it does not point to a subdirectory, but to a data entry.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        ResourceDataEntry_Manifest_CreateProcess<span class="code_symbol">:</span>
                .DataRva                dd Manifest_CreateProcess<span class="code_symbol">-</span>IMAGE_BASE
                .Size                   dd Manifest_CreateProcess.End<span class="code_symbol">-</span>Manifest_CreateProcess
                .Codepage               dd <span class="code_number">65001</span> <span class="code_annotation">;</span> <span class="code_annotation">UTF-8</span>
                .Reserved               dd <span class="code_number">0</span>    </pre></div>This structure defines the location of the resource contents, giving an RVA and size of the data. In addition, Codepage specifies the number of code page that should be used to decode texts when the resource contains any. We put the number of UTF-8 code page there, this is usually the most sensible choice.
<br>

<br>
What remains is to provide the data we just pointed to. We can use FILE to insert the content of a file directly into assembled output instead of having to define it with commands like DB:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        Manifest_CreateProcess<span class="code_symbol">:</span>
                                        file <span class="code_string">'manifest.xml'</span>
                .End<span class="code_symbol">:</span>

        ResourceTable.End<span class="code_symbol">:</span>    </pre></div>This concludes the resource structures. A program with such '.rsrc' section is attached as "resource_basic.asm" file. When assembled and run, it should cause the UAC confirmation to appear, requesting permission to run the program with administrative privileges. There is no need to grant the permission, the presence of the request is already a confirmation that the manifest resource has been noticed and understood. The system may also show a modified icon for the file, indicating that it requires elevated permissions.
<br>

<br>
Before we move on to experiment with other types of resources, we should better prepare another macro to make the construction of resource directories less tedious.
<br>

<br>
To be able to freely define contents of individual resources, we need a macro that can incorporate blocks of definitions. To generate the same resource section as in the basic example we would be using syntax like:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        resource_table

                resource RT_MANIFEST<span class="code_symbol">,</span> CREATEPROCESS_MANIFEST_RESOURCE_ID
                        file <span class="code_string">'manifest.xml'</span>
                end resource

        end resource_table    </pre></div>To achieve this, the RESOURCE_TABLE macro is going to temporarily define a couple other macros needed to mark the boundaries of the resources and of the whole table.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro resource_table?

        RC_INDEX <span class="code_symbol">=</span> <span class="code_number">0</span>

        macro resource? type<span class="code_symbol">*,</span>id<span class="code_symbol">*,</span>lang<span class="code_symbol">:</span><span class="code_number">0</span>
                RC_INDEX <span class="code_symbol">=</span> RC_INDEX <span class="code_symbol">+</span> <span class="code_number">1</span>
                repeat <span class="code_number">1</span><span class="code_symbol">,</span> i<span class="code_symbol">:</span>RC_INDEX
                        RC_TYPE.i <span class="code_symbol">:=</span> type
                        RC_ID.i <span class="code_symbol">:=</span> id
                        RC_LANG.i <span class="code_symbol">:=</span> lang
                        RC_RVA.i <span class="code_symbol">:=</span> $<span class="code_symbol">-</span>IMAGE_BASE
                        macro end?.resource?
                                RC_SIZE.i <span class="code_symbol">:=</span> $<span class="code_symbol">-</span>IMAGE_BASE<span class="code_symbol">-</span>RC_RVA.i
                                purge end?.resource?
                        end macro
                end repeat
        end macro    </pre></div>First it defines a macro that records an individual resource, with given type and identifier. Optionally a language can also be specified, by default it is zero. The resources are numbered according to the counter kept in RES_INDEX, in a manner similar to how we handled section definitions.
<br>

<br>
The inner macro in turn defines another one, specialized to end the definition of the started resource. When a macro is defined in the namespace of case-insensitive END symbol, it can be invoked by an END command looking similar to how the blocks of assembly commands are usually closed. In simple terms this means that such macro can be called by putting a space instead of a dot between the END and the specific name.
<br>

<br>
Because "i" is replaced with a number before the text inside REPEAT block is interpreted, the innermost macro has a text tailored to close the definition of one specific resource. To ensure that it cannot be executed more than once, the macro removes its own definition with PURGE. 
<br>

<br>
Similarly, the main macro also defines another one that is going to end the entire table:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        macro end?.resource_table?
                ResourceTable.End<span class="code_symbol">:</span>
                RESOURCE_COUNT <span class="code_symbol">:=</span> RC_INDEX
                purge resource?<span class="code_symbol">,</span> end?.resource_table?    </pre></div>It labels the end of all resource structures, defines a constant with total number of collected resources, and uses PURGE to remove the temporarily defined macros (including itself).
<br>

<br>
There is more to do at the end of the table, though.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                repeat RESOURCE_COUNT
                        RC_ORDER.% <span class="code_symbol">=</span> %
                end repeat
                D <span class="code_symbol">=</span> RESOURCE_COUNT
                while D <span class="code_symbol">&gt;</span> <span class="code_number">1</span>
                        D <span class="code_symbol">=</span> D shr <span class="code_number">1</span>
                        repeat RESOURCE_COUNT<span class="code_symbol">-</span>D
                                X <span class="code_symbol">=</span> D<span class="code_symbol">+</span>%
                                while X<span class="code_symbol">-</span>D <span class="code_symbol">&gt;</span> <span class="code_number">0</span>
                                        repeat <span class="code_number">1</span><span class="code_symbol">,</span> x_d<span class="code_symbol">:</span>X<span class="code_symbol">-</span>D<span class="code_symbol">,</span> x<span class="code_symbol">:</span>X
                                                repeat <span class="code_number">1</span><span class="code_symbol">,</span> i<span class="code_symbol">:</span>RC_ORDER.x_d<span class="code_symbol">,</span> j<span class="code_symbol">:</span>RC_ORDER.x
                                                        if RC_TYPE.i <span class="code_symbol">&gt;</span> RC_TYPE.j <span class="code_symbol">|\</span>
                                                          <span class="code_symbol">(</span>RC_TYPE.i <span class="code_symbol">=</span> RC_TYPE.j <span class="code_symbol">&amp;</span> RC_ID.i <span class="code_symbol">&gt;</span> RC_ID.j <span class="code_symbol">)</span> <span class="code_symbol">|\</span>
                                                          <span class="code_symbol">(</span>RC_TYPE.i <span class="code_symbol">=</span> RC_TYPE.j <span class="code_symbol">&amp;</span> RC_ID.i <span class="code_symbol">=</span> RC_ID.j <span class="code_symbol">&amp;</span> RC_LANG.i <span class="code_symbol">&gt;</span> RC_LANG.j<span class="code_symbol">)</span>
                                                                RC_ORDER.x_d <span class="code_symbol">=</span> j
                                                                RC_ORDER.x <span class="code_symbol">=</span> i
                                                        else
                                                                break
                                                        end if
                                                end repeat
                                        end repeat
                                        X <span class="code_symbol">=</span> X<span class="code_symbol">-</span>D
                                end while
                        end repeat
                end while
                repeat RESOURCE_COUNT<span class="code_symbol">,</span> i<span class="code_symbol">:</span><span class="code_number">1</span>
                        repeat <span class="code_number">1</span><span class="code_symbol">,</span> n<span class="code_symbol">:</span>RC_ORDER.%
                                RESOURCE_TYPE.i <span class="code_symbol">:=</span> RC_TYPE.n
                                RESOURCE_ID.i <span class="code_symbol">:=</span> RC_ID.n
                                RESOURCE_LANG.i <span class="code_symbol">:=</span> RC_LANG.n
                                RESOURCE_RVA.i <span class="code_symbol">:=</span> RC_RVA.n
                                RESOURCE_SIZE.i <span class="code_symbol">:=</span> RC_SIZE.n
                        end repeat
                end repeat
        end macro    </pre></div>The same sorting algorithm as in the export macro is used here to order the resources hierarchically, according to the type, identifier and language. What is actually sorted is a list of numbers of collected resources. At the end we define new constants to hold all the associated values in the new order. These are the final values that we are going to use to construct the resource directories. All symbols that had names starting with "RC_" were temporary, we can now forget about them.
<br>

<br>
If we had some resources identified by names instead of numbers, a simple comparing clause as above would not suffice to sort them correctly. Therefore we continue with the assumption that all identifiers are numeric. The additions needed to make the macro properly handle named resources would only make it harder to follow at the moment.
<br>

<br>
Back to the main macro, we can now use the values collected and sorted by inner macros to construct the tree. We still need a bit of preparation, though.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        TYPE_COUNT <span class="code_symbol">=</span> <span class="code_number">0</span>
        repeat RESOURCE_COUNT
                if % <span class="code_symbol">=</span> <span class="code_number">1</span> <span class="code_symbol">|</span> RESOURCE_TYPE.% <span class="code_symbol">&lt;&gt;</span> TYPE
                        TYPE <span class="code_symbol">=</span> RESOURCE_TYPE.%
                        TYPE_COUNT <span class="code_symbol">=</span> TYPE_COUNT <span class="code_symbol">+</span> <span class="code_number">1</span>
                        ID <span class="code_symbol">=</span> RESOURCE_ID.%
                        ID_FIRST <span class="code_symbol">=</span> %
                        ID_COUNT.% <span class="code_symbol">=</span> <span class="code_number">1</span>
                        LANG_FIRST <span class="code_symbol">=</span> %
                        LANG_COUNT.% <span class="code_symbol">=</span> <span class="code_number">1</span>
                else
                        if RESOURCE_ID.% <span class="code_symbol">&lt;&gt;</span> ID
                                ID <span class="code_symbol">=</span> RESOURCE_ID.%
                                repeat <span class="code_number">1</span><span class="code_symbol">,</span> first<span class="code_symbol">:</span>ID_FIRST
                                        ID_COUNT.first <span class="code_symbol">=</span> ID_COUNT.first <span class="code_symbol">+</span> <span class="code_number">1</span>
                                end repeat
                                LANG_FIRST <span class="code_symbol">=</span> %
                                LANG_COUNT.% <span class="code_symbol">=</span> <span class="code_number">1</span>
                        else
                                repeat <span class="code_number">1</span><span class="code_symbol">,</span> first<span class="code_symbol">:</span>LANG_FIRST
                                        LANG_COUNT.first <span class="code_symbol">=</span> LANG_COUNT.first <span class="code_symbol">+</span> <span class="code_number">1</span>
                                end repeat
                        end if
                end if
        end repeat    </pre></div>This loop counts the numbers of entries for each directory that we need to construct. It relies on the list being sorted hierarchically, but we already ensured that.
<br>

<br>
First, it increments TYPE_COUNT for every new type of resource it encounters, so this variable ends up holding the total number of types. Second, it counts how many different identifiers are there for a given type and keeps this value in ID_COUNT at a position being the number of first entry with such type. Finally, it counts how many entries are there that have the same type and identifier, storing this value in LANG_COUNT at a position being the number of the first such entry.
<br>

<br>
With all that sorting and counting done, the construction of resource directories is going to be pretty straighforward.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        align <span class="code_number">4</span>

        ResourceTable<span class="code_symbol">:</span>
                                .Characteristics        dd <span class="code_number">0</span>
                                .TimeDateStamp          dd <span class="code_number">0</span>
                                .MajorVersion           dw <span class="code_number">0</span>
                                .MinorVersion           dw <span class="code_number">0</span>
                                .NumberOfNameEntries    dw <span class="code_number">0</span>
                                .NumberOfIdEntries      dw TYPE_COUNT

        repeat RESOURCE_COUNT
                if defined ID_COUNT.%
                                                        dd RESOURCE_TYPE.%
                                                        dd <span class="code_number">0x80000000</span> <span class="code_symbol">+</span> ResourceTypeDirectory<span class="code_symbol">#</span>%<span class="code_symbol">-</span>ResourceTable
                end if
        end repeat    </pre></div>The above loop correctly generates the list of all distinct types, because ID_COUNT is only defined at positions that introduce a new one. The corresponding subdirectories are defined by the next loop:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        repeat RESOURCE_COUNT
                if defined ID_COUNT.%
                        ResourceTypeDirectory<span class="code_symbol">#</span>%<span class="code_symbol">:</span>
                                .Characteristics        dd <span class="code_number">0</span>
                                .TimeDateStamp          dd <span class="code_number">0</span>
                                .MajorVersion           dw <span class="code_number">0</span>
                                .MinorVersion           dw <span class="code_number">0</span>
                                .NumberOfNameEntries    dw <span class="code_number">0</span>
                                .NumberOfIdEntries      dw ID_COUNT.%
                end if
                if defined LANG_COUNT.%
                                                        dd RESOURCE_ID.%
                                                        dd <span class="code_number">0x80000000</span> <span class="code_symbol">+</span> ResourceIdDirectory<span class="code_symbol">#</span>%<span class="code_symbol">-</span>ResourceTable
                end if
        end repeat    </pre></div>Similarly, LANG_COUNT acts as an indicator of first item in a sequence of entries that differ only in language. The final level of subdirectories is made analogously to the previous one:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        repeat RESOURCE_COUNT
                if defined LANG_COUNT.%
                        ResourceIdDirectory<span class="code_symbol">#</span>%<span class="code_symbol">:</span>
                                .Characteristics        dd <span class="code_number">0</span>
                                .TimeDateStamp          dd <span class="code_number">0</span>
                                .MajorVersion           dw <span class="code_number">0</span>
                                .MinorVersion           dw <span class="code_number">0</span>
                                .NumberOfNameEntries    dw <span class="code_number">0</span>
                                .NumberOfIdEntries      dw LANG_COUNT.%
                end if
                                                        dd RESOURCE_LANG.%
                                                        dd ResourceDataEntry<span class="code_symbol">#</span>%<span class="code_symbol">-</span>ResourceTable
        end repeat    </pre></div>All that remains are the data entries for every resource:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        repeat RESOURCE_COUNT
                        ResourceDataEntry<span class="code_symbol">#</span>%<span class="code_symbol">:</span>
                                .DataRva                dd RESOURCE_RVA.%
                                .Size                   dd RESOURCE_SIZE.%
                                .Codepage               dd <span class="code_number">65001</span>
                                .Reserved               dd <span class="code_number">0</span>
        end repeat        

end macro    </pre></div>The code page is hard-coded, but we could easily allow to customize it by introducing another optional parameter next to the language.
<br>

<br>
With the complexities of sorted directories out of the way, we can now focus more on the contents of resources. We are going to construct a simple icon for our program.
<br>

<br>
An icon is defined through a resource of type RT_GROUP_ICON, which is a table that lists variants of the same image that differ in color depth or resolution. The actual images are stored in RT_ICON resources, each in its own one. It is a bit like if it was another level of the tree, a version of an icon chosen according to the language may in turn have multiple variants suitable for different display modes. But this arrangement predates the PE format and the tree structure of resource directories. Every image associated with an icon is a separate resource with its own identifier.
<br>

<br>
The identifier of an icon as seen through the API is the identifier of an RT_GROUP_ICON resource. We can choose an identifier freely. When Windows looks for an icon to display for presenting the program file, it simply selects the first one in the directory.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        IDI_MAIN_ICON <span class="code_symbol">:=</span> <span class="code_number">101</span>    </pre></div>
<br>
The format of RT_GROUP_ICON resource is very similar to the one of main header of an ICO file.
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        resource_table

                resource RT_GROUP_ICON<span class="code_symbol">,</span> IDI_MAIN_ICON

                        MainIcon<span class="code_symbol">:</span>

                                .idReserved             dw <span class="code_number">0</span>
                                .idType                 dw <span class="code_number">1</span>
                                .idCount                dw <span class="code_number">1</span>

                                .1.bWidth               db <span class="code_number">32</span>
                                .1.bHeight              db <span class="code_number">32</span>
                                .1.bColorCount          db <span class="code_number">16</span>
                                .1.bReserved            db <span class="code_number">0</span>
                                .1.wPlanes              dw <span class="code_number">1</span>
                                .1.wBitCount            dw <span class="code_number">4</span>
                                .1.dwBytesInRes         dd Icon_1.End<span class="code_symbol">-</span>Icon_1
                                .1.nId                  dw <span class="code_number">1</span>

                end resource    </pre></div>The value of idCount tells how many images the icon has. What follows is a table containing that many entries, to define each one of them. We set up an icon with 32x32 dimensions and a 16-color palette (which corresponds to 4 bits per pixel, as specified by wBitCount). The last field is the only difference between this structure and header of an ICO file. Where the latter has a 32-bit offset of the image inside the file, this table has 16-bit nId field giving the number of RT_ICON resource.
<br>

<br>
If we had more than one image, we would need to make sure that each gets a unique number. Here we just use 1 as the identifier of our single picture.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                resource RT_ICON<span class="code_symbol">,</span> <span class="code_number">1</span>

                        Icon_1<span class="code_symbol">:</span>

                                .biSize                 dd <span class="code_number">40</span>
                                .biWidth                dd <span class="code_number">32</span>
                                .biHeight               dd <span class="code_number">64</span>
                                .biPlanes               dw <span class="code_number">1</span>
                                .biBitCount             dw <span class="code_number">4</span>
                                .biCompression          dd <span class="code_number">0</span>
                                .biSizeImage            dd .Bitmap.end<span class="code_symbol">-</span>.Bitmap
                                .biXPelsPerMeter        dd <span class="code_number">0</span>
                                .biYPelsPerMeter        dd <span class="code_number">0</span>
                                .biClrUsed              dd <span class="code_number">16</span>
                                .biClrImportant         dd <span class="code_number">16</span>

                                .Palette<span class="code_symbol">:</span>
                                        repeat <span class="code_number">16</span><span class="code_symbol">,</span> i<span class="code_symbol">:</span><span class="code_number">0</span>
                                                db i<span class="code_symbol">*</span><span class="code_number">16</span><span class="code_symbol">,</span> i<span class="code_symbol">*</span><span class="code_number">16</span><span class="code_symbol">,</span> <span class="code_number">0</span><span class="code_symbol">,</span> <span class="code_number">0</span>
                                        end repeat
                                .Bitmap<span class="code_symbol">:</span>
                                        repeat <span class="code_number">32</span><span class="code_symbol">,</span> y<span class="code_symbol">:</span><span class="code_number">0</span>
                                                repeat <span class="code_number">32</span><span class="code_symbol">,</span> x<span class="code_symbol">:</span><span class="code_number">0</span>
                                                        COLOR <span class="code_symbol">=</span> <span class="code_symbol">(</span>x <span class="code_symbol">+</span> y<span class="code_symbol">)</span> <span class="code_symbol">/</span> <span class="code_number">4</span>
                                                        if x and <span class="code_number">1</span> <span class="code_symbol">=</span> <span class="code_number">1</span>
                                                                db HIGH shl <span class="code_number">4</span> <span class="code_symbol">+</span> COLOR
                                                        else
                                                                HIGH <span class="code_symbol">=</span> COLOR
                                                        end if
                                                end repeat
                                        end repeat
                                .Bitmap.mask<span class="code_symbol">:</span>
                                        db <span class="code_number">32</span> <span class="code_symbol">*</span> <span class="code_number">32</span> <span class="code_symbol">/</span> <span class="code_number">8</span> dup <span class="code_number">0</span>
                                .Bitmap.end<span class="code_symbol">:</span>

                        Icon_1.End<span class="code_symbol">:</span>

                end resource

        end resource_table    </pre></div>An RT_ICON resource has the same structure as individual image in ICO file. Its format is almost identical to one of a bitmap file, but the header must indicate double height (in this case 64) and after the main image there comes a mask with the same dimensions, encoded with one bit per pixel.
<br>

<br>
The mask provides an old and simple method of defining transparency. Where the bits in mask are zeroed, the icon is opaque. But in places where bits in mask are set, a XOR operation is performed to combine the background with the icon (it gives a true transparency only when the color of the image is zero at such point). For simplicity, we zero the entire mask and make an icon that is just a solid square filled with a simple diagonal gradient.
<br>

<br>
With a 16-color palette a single pixel occupies four bits, so there are two of them per byte. The HIGH variable temporarily holds the color of one pixel that is then combined with the next one. The layout of the image is as usual in bitmap files, with the first byte corresponding to the lower left corner of the square.
<br>

<br>
A program assembled with these resources should have such generated icon appearing in the directory view and file properties. An example source is provided in the "resource_icon.asm" file.</div>

<div class="signature"></div><span class="smalltext"></span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row2"><a href="https://board.flatassembler.net/topic.php?p=205474#205474"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  08 Aug 2018, 09:18</span></td>
                <td valign="middle" class="row2">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205474"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row1">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row1">
                  <a name="205476"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">08 Aug 2018, 12:46</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title=""><strong style="font-weight: bold">1.5  Moving to 64 bits with PE+</strong>
<br>

<br>
PE+ is a variant used when the target architecture uses 64-bit addresses instead of 32-bit. It has some of the fields adjusted so that they can hold larger values, though there are only few such places. All RVA values are expected to still fit in 32 bits and their corresponding fields are unchanged.
<br>

<br>
To make an example that uses such format we need to move to an architecture with large addresses. An obvious choice is the 64-bit successor of x86, traditionally called x86-64 (or x64 for short). To set it up we need to replace the lines we have been using to select the 32-bit 80386 instruction set:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>use <span class="code_string">'x64.inc'</span>
use64    </pre></div>Not only we include the larger instruction set of a x64 processor, we also switch to code generator to long mode with USE64.
<br>

<br>
Consequently, we need to change the Machine field in the main header to relect the new choice:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .Machine                        dw IMAGE_FILE_MACHINE_AMD64    </pre></div>We also need to update the image flags so that they are appropriate for 64-bit world:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .Characteristics                dw IMAGE_FILE_EXECUTABLE_IMAGE <span class="code_symbol">+</span> IMAGE_FILE_LARGE_ADDRESS_AWARE    </pre></div>
<br>
To indicate that the image uses PE+ format, Magic value in the optional header needs to be set to 0x20B. To make the template a bit more flexible, we are going to define another constant next to DEFAULT_IMAGE_BASE:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>MAGIC <span class="code_symbol">:=</span> <span class="code_number">0x20B</span>    </pre></div>We then modify the optional header to acknowledge this definition:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .Magic                          dw MAGIC    </pre></div>
<br>
In places where the structure of PE+ differs from the classic one, we will change it conditionally, depending on the value of MAGIC. This should allow the template to correctly produce either variant of PE, with switching done in a single place. 
<br>

<br>
The value of ImageBase is a an absolute address and it needs to be 64-bit, but the required extension is done in such way that the offsets of fields further down remain unchanged. The larger address occupies the space of two fields of the original header. BaseOfData, which preceded ImageBase, is sacrificed for this purpose and is no longer present in PE+ header:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>if MAGIC <span class="code_symbol">=</span> <span class="code_number">0x20B</span>
        .ImageBase                      dq DEFAULT_IMAGE_BASE
else
        .BaseOfData                     dd <span class="code_number">0</span>
        .ImageBase                      dd DEFAULT_IMAGE_BASE
end if    </pre></div>
<br>
The other fields that need extending are the ones related to sizes of stack and heap. They are near the end of the header and are simply expanded to the larger size.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>if MAGIC <span class="code_symbol">=</span> <span class="code_number">0x20B</span>
        .SizeOfStackReserve             dq <span class="code_number">4096</span>
        .SizeOfStackCommit              dq <span class="code_number">4096</span>
        .SizeOfHeapReserve              dq <span class="code_number">65536</span>
        .SizeOfHeapCommit               dq <span class="code_number">0</span>
else
        .SizeOfStackReserve             dd <span class="code_number">4096</span>
        .SizeOfStackCommit              dd <span class="code_number">4096</span>
        .SizeOfHeapReserve              dd <span class="code_number">65536</span>
        .SizeOfHeapCommit               dd <span class="code_number">0</span>
end if    </pre></div>We now have set up a valid optional header for PE+. But this is not the only structure that changes in this variant of the format.
<br>

<br>
Another place where some fields need to be enlarged is the import table. The entries in IAT should be 64-bit to be able to contain the imported addresses. And because the initial content of IAT should be identical to ILT, the other table is affected as well. We can modify the IMPORT macro as follows to make it generate appropriate structures for either variant of PE:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro import? items<span class="code_symbol">&amp;</span>

        align <span class="code_number">4</span>

        ImportTable<span class="code_symbol">:</span>

        iterate item<span class="code_symbol">,</span> items
                match name.<span class="code_symbol">=</span>DLL?<span class="code_symbol">,</span> item
                        .name.ImportLookupTableRva      dd ImportLookupTable.name<span class="code_symbol">-</span>IMAGE_BASE
                        .name.TimeDateStamp             dd <span class="code_number">0</span>
                        .name.ForwarderChain            dd <span class="code_number">0</span>
                        .name.NameRva                   dd ImportLibraryName.name<span class="code_symbol">-</span>IMAGE_BASE
                        .name.ImportAddressTableRva     dd ImportAddressTable.name<span class="code_symbol">-</span>IMAGE_BASE
                else if % <span class="code_symbol">=</span> <span class="code_number">1</span>
                        err <span class="code_string">'please</span> <span class="code_string">start</span> <span class="code_string">with</span> <span class="code_string">a</span> <span class="code_string">name</span> <span class="code_string">of</span> <span class="code_string">a</span> <span class="code_string">DLL'</span>
                end if
        end iterate
                        if MAGIC <span class="code_symbol">&lt;&gt;</span> <span class="code_number">0x20B</span>
                                                        dd <span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span>
                        else
                                                        dd <span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span><span class="code_symbol">,</span><span class="code_number">0</span>
                                                        align <span class="code_number">8</span><span class="code_symbol">,</span> <span class="code_number">0</span>
                        end if

        iterate item<span class="code_symbol">,</span> items
                match name.<span class="code_symbol">=</span>DLL?<span class="code_symbol">,</span> item
                        if MAGIC <span class="code_symbol">&lt;&gt;</span> <span class="code_number">0x20B</span>
                                                        dd <span class="code_number">0</span>
                        else
                                                        dq <span class="code_number">0</span>
                        end if
                        ImportLookupTable.name<span class="code_symbol">:</span>
                else
                        if MAGIC <span class="code_symbol">&lt;&gt;</span> <span class="code_number">0x20B</span>
                                                        dd ImportLookup.item<span class="code_symbol">-</span>IMAGE_BASE
                        else
                                                        dq ImportLookup.item<span class="code_symbol">-</span>IMAGE_BASE
                        end if
                end match
        end iterate

        iterate item<span class="code_symbol">,</span> items
                match name.<span class="code_symbol">=</span>DLL?<span class="code_symbol">,</span> item
                        if MAGIC <span class="code_symbol">&lt;&gt;</span> <span class="code_number">0x20B</span>
                                                        dd <span class="code_number">0</span>
                        else
                                                        dq <span class="code_number">0</span>
                        end if
                        ImportAddressTable.name<span class="code_symbol">:</span>
                else
                        if MAGIC <span class="code_symbol">&lt;&gt;</span> <span class="code_number">0x20B</span>
                                item                    dd ImportLookup.item<span class="code_symbol">-</span>IMAGE_BASE
                        else
                                item                    dq ImportLookup.item<span class="code_symbol">-</span>IMAGE_BASE
                        end if
                end match
        end iterate
                        if MAGIC <span class="code_symbol">&lt;&gt;</span> <span class="code_number">0x20B</span>
                                                        dd <span class="code_number">0</span>
                        else
                                                        dq <span class="code_number">0</span>
                        end if

        iterate item<span class="code_symbol">,</span> items
                match name.<span class="code_symbol">=</span>DLL?<span class="code_symbol">,</span> item
                        ImportLibraryName.name          db <span class="code_symbol">`</span>item<span class="code_symbol">,</span><span class="code_number">0</span>
                else
                                                        align <span class="code_number">2</span>
                        ImportLookup.item<span class="code_symbol">:</span>
                                                        dw <span class="code_number">0</span>
                                                        db <span class="code_symbol">`</span>item<span class="code_symbol">,</span><span class="code_number">0</span>
                end match
        end iterate

        ImportTable.End<span class="code_symbol">:</span>

end macro    </pre></div>The empty entry at the end of the main table has only three of its five fields initially generated in PE+ case, the missing two are going to be generated by subsequent DQ. There is an alignment clause added in between, to ensure that 64-bit fields are laid out naturally in memory.
<br>

<br>
In places like the export table or resource section there is nothing to do, all these structures use only relative addresses and these are kept in 32-bit fields. The relocations may need some attention, but first we need to have an actual code, and this is a section that needs to be rewritten completely.
<br>

<br>
As we have switched to a different machine architecture, we need to adapt to the new instruction set and calling conventions used by the functions of the operating system. This portion of our program should now look like:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>section <span class="code_string">'.text'</span><span class="code_symbol">,</span> IMAGE_SCN_MEM_EXECUTE <span class="code_symbol">+</span> IMAGE_SCN_MEM_READ

        EntryPoint<span class="code_symbol">:</span>

                sub     rsp<span class="code_symbol">,</span><span class="code_number">8</span><span class="code_symbol">*</span><span class="code_number">5</span>

                mov     r9d<span class="code_symbol">,</span><span class="code_number">0</span>
                lea     r8<span class="code_symbol">,[</span>CaptionString<span class="code_symbol">]</span>
                lea     rdx<span class="code_symbol">,[</span>MessageString<span class="code_symbol">]</span>
                mov     rcx<span class="code_symbol">,</span><span class="code_number">0</span>
                call    <span class="code_symbol">[</span>MessageBoxA<span class="code_symbol">]</span>

                mov     ecx<span class="code_symbol">,</span><span class="code_number">0</span>
                call    <span class="code_symbol">[</span>ExitProcess<span class="code_symbol">]</span>

section <span class="code_string">'.rdata'</span><span class="code_symbol">,</span> IMAGE_SCN_MEM_READ

        import USER32.DLL<span class="code_symbol">,</span> MessageBoxA<span class="code_symbol">,</span> <span class="code_symbol">\</span>
               KERNEL32.DLL<span class="code_symbol">,</span> ExitProcess

        CaptionString db <span class="code_string">"PE</span> <span class="code_string">tutorial"</span><span class="code_symbol">,</span><span class="code_number">0</span>
        MessageString db <span class="code_string">"I</span> <span class="code_string">am</span> <span class="code_string">64-bit,</span> <span class="code_string">alive</span> <span class="code_string">and</span> <span class="code_string">well!"</span><span class="code_symbol">,</span><span class="code_number">0</span>    </pre></div>The code is a bit more complex than in 32-bit case, for a curious reader this might deserve a bit of a commentary.
<br>

<br>
The initial SUB instruction adjusts the stack pointer to reserve a space required by convention for the later function calls and at the same time it also corrects the alignment of the stack. The operating system requires that address to be a multiple of 16 before a function is called, but at entry point it is misaligned by 8 bytes. This is analogous to a starting point of a function, the misalignment is caused by a 64-bit return address stored on the stack.
<br>

<br>
The function calling convention used by Windows on x86-64 uses registers to pass the first four parameters, while the further ones are passed on the stack. None of the functions we call in our simple program takes more than four parameters, so we only need to put the values in registers. Nevertheless, a space for the first four parameters has to be reserved on the stack anyway, a function is allowed to use that area to keep their values. This means that we need to reserve at least four 64-bit units of stack space, but to fix the misalignment there must be an odd number of them, therefore we take five units in total.
<br>

<br>
In the long mode of x86-64 processor, when an instruction has a memory operand (these are the ones enclosed in square brackets), the corresponding machine code does not contain an absolute address but an offset relative to the instruction pointer. The distances within the same image never change, therefore such code does not need relocating. To set up parameters that contain addresses we used LEA instead of MOV to take advantage of this feature. It makes the entire program freely movable with no relocations to apply. So even if we get rid of DD macro (so far our only way to gather relocation entries) we can assemble with PE+ with dynamic base and run it with no issues.
<br>

<br>
However, in case we wanted to experiment with 64-bit instructions that may need relocations after all, we should prepare macros like this:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>if MAGIC <span class="code_symbol">&lt;&gt;</span> <span class="code_number">0x20B</span>
        macro dd? data<span class="code_symbol">&amp;</span>
                iterate unit<span class="code_symbol">,</span> data
                        match ?<span class="code_symbol">,</span> unit
                                dd ?
                        else if unit relativeto BASE_RELOCATION
                                repeat <span class="code_number">1</span><span class="code_symbol">,</span> i<span class="code_symbol">:</span>FIXUP_INDEX
                                        FIXUP_RVA_<span class="code_symbol">#</span>i <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> IMAGE_BASE
                                        FIXUP_TYPE_<span class="code_symbol">#</span>i <span class="code_symbol">:=</span> IMAGE_REL_BASED_HIGHLOW
                                end repeat
                                FIXUP_INDEX <span class="code_symbol">=</span> FIXUP_INDEX <span class="code_symbol">+</span> <span class="code_number">1</span>
                                dd unit<span class="code_symbol">-</span>BASE_RELOCATION
                        else
                                dd unit
                        end if
                end iterate
        end macro
else
        macro dq? data<span class="code_symbol">&amp;</span>
                iterate unit<span class="code_symbol">,</span> data
                        match ?<span class="code_symbol">,</span> unit
                                dq ?
                        else if unit relativeto BASE_RELOCATION
                                repeat <span class="code_number">1</span><span class="code_symbol">,</span> i<span class="code_symbol">:</span>FIXUP_INDEX
                                        FIXUP_RVA_<span class="code_symbol">#</span>i <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> IMAGE_BASE
                                        FIXUP_TYPE_<span class="code_symbol">#</span>i <span class="code_symbol">:=</span> IMAGE_REL_BASED_DIR64
                                end repeat
                                FIXUP_INDEX <span class="code_symbol">=</span> FIXUP_INDEX <span class="code_symbol">+</span> <span class="code_number">1</span>
                                dq unit<span class="code_symbol">-</span>BASE_RELOCATION
                        else
                                dq unit
                        end if
                end iterate
        end macro
end if    </pre></div>To handle different kinds of relocations we gather their types together with addresses, this requires also a small change in the ".reloc" section generator:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                                        repeat <span class="code_symbol">(</span>INDEX<span class="code_symbol">-</span>FIRST<span class="code_symbol">),</span> i<span class="code_symbol">:</span>FIRST
                                                dw FIXUP_RVA_<span class="code_symbol">#</span>i and <span class="code_number">0xFFF</span> <span class="code_symbol">+</span> FIXUP_TYPE_<span class="code_symbol">#</span>i shl <span class="code_number">12</span>
                                        end repeat    </pre></div>We may test the 64-bit fixups by modifying the code to use some instructions that hand the 64-bit addresses directly:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                mov     r9d<span class="code_symbol">,</span><span class="code_number">0</span>
                mov     r8<span class="code_symbol">,</span>CaptionString
                mov     rdx<span class="code_symbol">,</span>MessageString
                mov     rcx<span class="code_symbol">,</span><span class="code_number">0</span>
                call    <span class="code_symbol">[</span>MessageBoxA<span class="code_symbol">]</span>    </pre></div></div>

<div class="signature"></div><span class="smalltext"><br><br>Last edited by Tomasz Grysztar on 28 Jan 2023, 14:46; edited 3 times in total</span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row1"><a href="https://board.flatassembler.net/topic.php?p=205476#205476"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  08 Aug 2018, 12:46</span></td>
                <td valign="middle" class="row1">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205476"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row2">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row2">
                  <a name="205549"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">16 Aug 2018, 09:08</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title=""><strong style="font-weight: bold">1.6  Experimenting further</strong>
<br>

<br>
We already have several constants defined near the beginning of our source that could be used to customize the produced image, like DEFAULT_IMAGE_BASE or SECTION_ALIGNMENT. But if we are to start toying with them, we should consider the constraints imposed by specification. For example, base of the image is required to be a multiple of 0x10000.
<br>

<br>
To make sure that our custom values do not break the rules, we should add some checks that would remind us of the guidelines when we cross them. The simplest way to do it is an ASSERT statement:
<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>assert DEFAULT_IMAGE_BASE mod <span class="code_number">0x10000</span> <span class="code_symbol">=</span> <span class="code_number">0</span>    </pre></div>When the value does not meet the condition, the assembler is going to signalize an error. We could also use IF combined with ERR to show a customized message, like we did in the IMPORT macro - this might be a good idea when an ASSERT is not self-explanatory.
<br>

<br>
As mentioned earlier, the ALIGN macro could also use some check in case it was used with freely chosen numbers:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro align? pow2<span class="code_symbol">*,</span>value<span class="code_symbol">:</span>?
        assert bsf<span class="code_symbol">(</span>pow2<span class="code_symbol">)</span> <span class="code_symbol">=</span> bsr<span class="code_symbol">(</span>pow2<span class="code_symbol">)</span>
        if $ relativeto BASE_RELOCATION
                assert pow2 <span class="code_symbol">&lt;=</span> <span class="code_number">0x10000</span>
                db <span class="code_symbol">(</span>BASE_RELOCATION<span class="code_symbol">-</span>$<span class="code_symbol">)</span>and<span class="code_symbol">(</span>pow2<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span> dup value
        else
                db <span class="code_symbol">(-</span>$<span class="code_symbol">)</span>and<span class="code_symbol">(</span>pow2<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span> dup value
        end if
end macro    </pre></div>The first ASSERT above check whether the value of "pow2" parameter is truly a power of two. BSF and BSR operators give the indexes of lowest and highest set bit in the binary representation of a number, so when they give the same result the number has exactly one set bit, as powers of two do. The second ASSERT reflects the limitations on aligning an address that might move when image is relocated to a different base.
<br>

<br>
The specification gives a few additional rules concerning non-standard aligments. The SECTION_ALIGNMENT must not be smaller that FILE_ALIGNMENT, and if it is smaller than the page size (0x1000 bytes for x86 architectures) the two values need to be equal:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>assert SECTION_ALIGNMENT <span class="code_symbol">&gt;=</span> FILE_ALIGNMENT
if SECTION_ALIGNMENT <span class="code_symbol">&lt;</span> <span class="code_number">0x1000</span>
        assert FILE_ALIGNMENT <span class="code_symbol">=</span> SECTION_ALIGNMENT
end if    </pre></div>Moreover, when such small alignment is used, an RVA must always be equal to the corresponding offset in file. Therefore sections may not contain reserved data that would not occupy a space in file and to ensure it we need to modify portion of SECTION macro:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                if SECTION_ALIGNMENT <span class="code_symbol">&lt;</span> <span class="code_number">0x1000</span>
                        org $%%
                else
                        section $%%
                end if
                align FILE_ALIGNMENT<span class="code_symbol">,</span><span class="code_number">0</span>    </pre></div>It should be noted that some of the properties of memory, like being writable or executable, can only be applied to entire pages at once. Therefore when a smaller number is used for alignment it is not possible to correctly apply such attributes to individual sections and these settings are ignored.
<br>

<br>
A 64-bit template with these additions is in the attached "universal_template.asm" file. It may serve as a starting point for futher experiments.
<br>

<br>
For example, to morph the template back into a 32-bit program, there are only a few simple steps needed. To adjust the format of the file, it is enough to change the value of Machine field to IMAGE_FILE_MACHINE_I386 and set MAGIC to 0x10B. In addition to that the actual program instructions in ".text" section need to be replaced and this requires USE32 in place of USE64. The "x64.inc" can stay included, it can handle both modes.
<br>
 
<br>
Nevertheless, there is more that could be done to make the template easily customizable. Headers and macros could be moved to a separate file that normally would not need to be modified and constants defining more options could be introduced. At this point it should be an easy exercise to anyone interested in experimenting more with these examples. 
<br>

<br>
Instead, we are now going to try some new tricks. Earlier we omitted the computation of the checksum, because it is not needed for usual programs. But it is something worth having in a toolbox, in case it ever becomes necessary. To calculate correct checksum for a program made from our template, the following block of commands should suffice:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>postpone ?
        CHECKSUM <span class="code_symbol">=</span> <span class="code_number">0</span>
        repeat $% shr <span class="code_number">1</span><span class="code_symbol">,</span> POSITION<span class="code_symbol">:</span><span class="code_number">0</span>
                load H<span class="code_symbol">:</span>word from <span class="code_symbol">:</span>POSITION shl <span class="code_number">1</span>
                CHECKSUM <span class="code_symbol">=</span> CHECKSUM <span class="code_symbol">+</span> H
        end repeat
        while CHECKSUM shr <span class="code_number">16</span>
                CHECKSUM <span class="code_symbol">=</span> CHECKSUM shr <span class="code_number">16</span> <span class="code_symbol">+</span> CHECKSUM and <span class="code_number">0FFFFh</span>
        end while
        CHECKSUM <span class="code_symbol">=</span> CHECKSUM <span class="code_symbol">+</span> $%
        store CHECKSUM<span class="code_symbol">:</span>dword at <span class="code_symbol">:</span>OptionalHeader.CheckSum<span class="code_symbol">-</span>IMAGE_BASE
end postpone    </pre></div>We use a special variant of POSTPONE, with added question mark, that is assembled not only after the other parts of source, but only if all the values in the other parts have been resolved. This lets the assembler avoid wasting time on interpreting these commands until the content of generated file has reached its final form.
<br>

<br>
The LOAD allows to read from the previously generated output, with the colon before the address meaning that it is an offset within the produced file. After the calculation is done, the value in optional header is updated with STORE, which has syntax analogous to LOAD.
<br>

<br>
Because Windows does not require correct checksum in the normal programs it executes, some third-party tool may be needed to verify that the result of this computation is valid. On the other hand, if there is no way to tell whether the checksum is correct, it also means that it is not really necessary.
<br>

<br>
Obviously, the checksum can also be computed and updated on a previously generated image. We can even do it with the same assembler, by using FILE command to read the contents of PE file and then update it with STORE before it is written to the new output:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>file <span class="code_string">"universal_template.exe"</span>

load STUB_SIGNATURE<span class="code_symbol">:</span><span class="code_number">2</span> from <span class="code_number">0</span>
load PE_OFFSET<span class="code_symbol">:</span><span class="code_number">4</span> from <span class="code_number">0x3C</span>
load PE_SIGNATURE<span class="code_symbol">:</span><span class="code_number">4</span> from PE_OFFSET

if STUB_SIGNATURE <span class="code_symbol">=</span> <span class="code_string">"MZ"</span> <span class="code_symbol">&amp;</span> PE_SIGNATURE <span class="code_symbol">=</span> <span class="code_string">"PE"</span>

        CHECKSUM_OFFSET <span class="code_symbol">=</span> PE_OFFSET <span class="code_symbol">+</span> <span class="code_number">24</span> <span class="code_symbol">+</span> <span class="code_number">64</span>

        CHECKSUM <span class="code_symbol">=</span> <span class="code_number">0</span>
        store CHECKSUM<span class="code_symbol">:</span><span class="code_number">4</span> at CHECKSUM_OFFSET

        repeat $% shr <span class="code_number">1</span><span class="code_symbol">,</span> POSITION<span class="code_symbol">:</span><span class="code_number">0</span>
                load H<span class="code_symbol">:</span>word from <span class="code_symbol">:</span>POSITION shl <span class="code_number">1</span>
                CHECKSUM <span class="code_symbol">=</span> CHECKSUM <span class="code_symbol">+</span> H
        end repeat
        while CHECKSUM shr <span class="code_number">16</span>
                CHECKSUM <span class="code_symbol">=</span> CHECKSUM shr <span class="code_number">16</span> <span class="code_symbol">+</span> CHECKSUM and <span class="code_number">0FFFFh</span>
        end while
        CHECKSUM <span class="code_symbol">=</span> CHECKSUM <span class="code_symbol">+</span> $%

        store CHECKSUM<span class="code_symbol">:</span><span class="code_number">4</span> at CHECKSUM_OFFSET

else

        err <span class="code_string">'PE</span> <span class="code_string">format</span> <span class="code_string">not</span> <span class="code_string">recognized'</span>

end if    </pre></div>This time LOAD and STORE can use the regular addresses, as they are equal to the offset within file, because the content of the file was loaded at address 0. This method allows to re-calculate and update the checksum in any PE image, even one not produced by us.
<br>

<br>
The same template can also be adapted to produce files for non-x86 architectures. For example, just a couple of changes suffices to make an ARM64 executable.
<br>

<br>
Obviously, we need to switch the CPU instruction set. Replace    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>use <span class="code_string">'x64.inc'</span>
use64    </pre></div>with    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>use <span class="code_string">'aarch64.inc'</span>

define xIP0? x16
define xIP1? x17    </pre></div>These additional register aliases are related to <a href="https://devblogs.microsoft.com/oldnewthing/20220726-00/?p=106898" target="_blank" class="postlink">Windows conventions</a>, x16 and x17 are designed as "intra-procedure call scratch registers" and we are going to use one of them under this alias to make import stubs for calling Windows API.
<br>

<br>
The default image base needs to be different for ARM64:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>DEFAULT_IMAGE_BASE <span class="code_symbol">:=</span> <span class="code_number">0x140000000</span>    </pre></div>The change of target architecture should be quite obvious:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        .Machine                        dw IMAGE_FILE_MACHINE_ARM64    </pre></div>Now all that is left is to replace the x86 code.    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>        EntryPoint<span class="code_symbol">:</span>

                mov     x0<span class="code_symbol">,</span><span class="code_number">0</span>
                adr     x1<span class="code_symbol">,</span>MessageString
                adr     x2<span class="code_symbol">,</span>CaptionString
                mov     x3<span class="code_symbol">,</span><span class="code_number">0</span>
                bl      stub_MessageBoxA

                bl      stub_ExitProcess

        stub_MessageBoxA<span class="code_symbol">:</span>
                adr     xip0<span class="code_symbol">,</span>MessageBoxA
                ldr     xip0<span class="code_symbol">,[</span>xip0<span class="code_symbol">]</span>
                br      xip0

        stub_ExitProcess<span class="code_symbol">:</span>
                adr     xip0<span class="code_symbol">,</span>ExitProcess
                ldr     xip0<span class="code_symbol">,[</span>xip0<span class="code_symbol">]</span>
                br      xip0    </pre></div>While x86 code could also use import stubs to avoid indirect call instruction (which has a slightly longer opcode that direct one), in case of ARM they are pretty much necessary - there is no such instruction as x86's indirect call. We are using ADR to get the address of the pointer, it is encoded with PC-relative value and does not require relocation. The standard stubs in Windows are similar, but they use ADRP to get the address of the page of pointers, and then LDR adding offset within the page, which would look something like this:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>                adrp    xip0<span class="code_symbol">,</span>MessageBoxA
                ldr     xip0<span class="code_symbol">,[</span>xip0<span class="code_symbol">,(</span>MessageBoxA<span class="code_symbol">-</span>IMAGE_BASE<span class="code_symbol">)</span> and <span class="code_number">0FFFh</span><span class="code_symbol">]</span>    </pre></div>It allows a longer range between the stub code and the import table, since ADR only operates within 1M radius. For a tiny example constructed in assembly this does not matter, though.</div>

<div class="signature"></div><span class="smalltext"><br><br>Last edited by Tomasz Grysztar on 30 Jan 2023, 09:08; edited 2 times in total</span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row2"><a href="https://board.flatassembler.net/topic.php?p=205549#205549"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  16 Aug 2018, 09:08</span></td>
                <td valign="middle" class="row2">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205549"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row1">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row1">
                  <a name="205881"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">08 Sep 2018, 16:32</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title=""><strong style="font-weight: bold">Chapter 2
<br>
ELF (Executable and Linkable Format)</strong>
<br>

<br>
<a href="http://refspecs.linuxbase.org/elf/elf.pdf" target="_blank" class="postlink">ELF</a> was initially designed for Unix systems as a successor to COFF, having a more extendable structure and fewer limitations. It should be noted that the original COFF was not nearly as complex as its evolved forms known today. Around 1989, when the development of Windows NT was starting and its PE/COFF variations were most likely being conceived, Unix System V Release 4 was already out, using a fresh design of ELF in place of older COFF. Interestingly, around the same time NeXT machines started showing up, with a system that used another new format called Mach-O (arguably the most powerful of the three). Each of these formats uses a different approach to arrange its contents, even though there may have been at least some convergent evolution in their capabilities.
<br>

<br>
As the name implies, ELF can be used both for directly executable files and for linkable objects that are intermediate stage in a compilation. Since there are many structures that are required by one of these variants but not the other, ELF has flexible headers that allow to include only the tables that are relevant. Nevertheless it is always possible for an ELF file to contain all the tables, even the ones that are not mandatory for a given variant. For example, executable file produced by a compiler is likely to contain a symbol table, even though its presence is only required in the object files.
<br>

<br>
<strong style="font-weight: bold">2.1  A minimal executable file</strong>
<br>

<br>
Nowadays the most common system using ELF is Linux, therefore it is going to be a platform for our experiments. The first one is going to be a tiny executable containing only the parts of ELF format that are absolutely necessary for a valid program.
<br>

<br>
Because some of the Linux systems on x86-64 architecture may not be able to run 32-bit programs, this time we have no common denominator. Therefore, right from the start, we will prepare examples in a flexible form that may produce either a 32-bit or 64-bit file. The differences in structure of such two variants are relatively few.
<br>

<br>
To select which variant we want to create, we are going to define a constant using the "-i" switch in the command line. A command to assemble 32-bit file could look like:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>fasmg basic.asm <span class="code_symbol">-</span>i include<span class="code_symbol">\</span> <span class="code_string">'listing.inc'</span> <span class="code_symbol">-</span>i MACHINE<span class="code_symbol">:=</span>EM_386    </pre></div>And one to assemble 64-bit program would be:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>fasmg basic.asm <span class="code_symbol">-</span>i include<span class="code_symbol">\</span> <span class="code_string">'listing.inc'</span> <span class="code_symbol">-</span>i MACHINE<span class="code_symbol">:=</span>EM_X86_64    </pre></div>or:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>fasmg basic.asm <span class="code_symbol">-</span>i include<span class="code_symbol">\</span> <span class="code_string">'listing.inc'</span> <span class="code_symbol">-</span>i MACHINE<span class="code_symbol">:=</span>EM_AARCH64    </pre></div>All that the "-i" switch does is to insert a line in the beginning of assembled text. We are going to construct the example in such way that this definition should be valid and recognized.
<br>

<br>
Let us start with the same couple of simple macros as in the previous chapter, and also read a set of constants from the "elf.inc" file:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro align? pow2<span class="code_symbol">*,</span>value<span class="code_symbol">:</span>?
        db  <span class="code_symbol">(-</span>$<span class="code_symbol">)</span> and <span class="code_symbol">(</span>pow2<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span>  dup value
end macro

macro use? file<span class="code_symbol">*</span>
        include file
end macro

use <span class="code_string">'elf.inc'</span>    </pre></div>Names and numeric values of these constants are extracted from ELF specification, and this includes EM_386 and EM_X86_64 that we already use in the declarations inserted from command line. We are going to put the chosen number into the corresponding field in the ELF header, but we can also use it to determine a few other things that depend on whether we plan to generate a 32-bit or 64-bit execuable:    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>if MACHINE <span class="code_symbol">=</span> EM_386
        CLASS <span class="code_symbol">:=</span> ELFCLASS32
        BASE_ADDRESS <span class="code_symbol">:=</span> <span class="code_number">0x8048000</span>
        use <span class="code_string">'80386.inc'</span>
        use32
else if MACHINE <span class="code_symbol">=</span> EM_X86_64
        CLASS <span class="code_symbol">:=</span> ELFCLASS64
        BASE_ADDRESS <span class="code_symbol">:=</span> <span class="code_number">0x400000</span>
        use <span class="code_string">'x64.inc'</span>
        use64
else if MACHINE <span class="code_symbol">=</span> EM_AARCH64
        CLASS <span class="code_symbol">:=</span> ELFCLASS64
        BASE_ADDRESS <span class="code_symbol">:=</span> <span class="code_number">0x400000</span>
        use <span class="code_string">'aarch64.inc'</span>
end if    </pre></div>The ELFCLASS32 and ELFCLASS64 are another constants taken from the ELF specification that we later need to place into the right field in the header, they also affect the layout of entire file (similarly to the differences between PE and PE+ discussed in the previous chapter).
<br>

<br>
<em style="font-style: italic">To be continued...</em>
<br>

<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>org BASE_ADDRESS

Header<span class="code_symbol">:</span>

        .e_ident        db <span class="code_number">0x7F</span><span class="code_symbol">,</span> <span class="code_string">'ELF'</span><span class="code_symbol">,</span> CLASS<span class="code_symbol">,</span> ELFDATA2LSB<span class="code_symbol">,</span> EV_CURRENT<span class="code_symbol">,</span> ELFOSABI_LINUX<span class="code_symbol">,</span> <span class="code_symbol">(</span>.e_ident<span class="code_symbol">+</span><span class="code_number">16</span><span class="code_symbol">-</span>$<span class="code_symbol">)</span> dup <span class="code_number">0</span>
        .e_type         dw ET_EXEC
        .e_machine      dw MACHINE
        .e_version      dd EV_CURRENT
if CLASS <span class="code_symbol">=</span> ELFCLASS32
        .e_entry        dd start
        .e_phoff        dd PROGRAM_HEADER_OFFSET
        .e_shoff        dd <span class="code_number">0</span>
else
        .e_entry        dq start
        .e_phoff        dq PROGRAM_HEADER_OFFSET
        .e_shoff        dq <span class="code_number">0</span>
end if
        .e_flags        dd <span class="code_number">0</span>
        .e_ehsize       dw HEADER_LENGTH
        .e_phentsize    dw SEGMENT_HEADER_LENGTH
        .e_phnum        dw NUMBER_OF_SEGMENTS
        .e_shentsize    dw SECTION_HEADER_LENGTH
        .e_shnum        dw <span class="code_number">0</span>
        .e_shstrndx     dw <span class="code_number">0</span>

HEADER_LENGTH <span class="code_symbol">:=</span> $%

PROGRAM_HEADER_OFFSET <span class="code_symbol">:=</span> $%

ProgramHeader<span class="code_symbol">:</span>

if CLASS <span class="code_symbol">=</span> ELFCLASS32
        repeat NUMBER_OF_SEGMENTS<span class="code_symbol">,</span> n<span class="code_symbol">:</span><span class="code_number">1</span>
                .n.p_type       dd Segment.n.TYPE
                .n.p_offset     dd Segment.n.OFFSET
                .n.p_vaddr      dd Segment.n.ADDRESS
                .n.p_paddr      dd Segment.n.ADDRESS
                .n.p_filesz     dd Segment.n.SIZE_IN_FILE
                .n.p_memsz      dd Segment.n.SIZE_IN_MEMORY
                .n.p_flags      dd Segment.n.FLAGS
                .n.p_align      dd Segment.n.ALIGN
        end repeat
else
        repeat NUMBER_OF_SEGMENTS<span class="code_symbol">,</span> n<span class="code_symbol">:</span><span class="code_number">1</span>
                .n.p_type       dd Segment.n.TYPE
                .n.p_flags      dd Segment.n.FLAGS
                .n.p_offset     dq Segment.n.OFFSET
                .n.p_vaddr      dq Segment.n.ADDRESS
                .n.p_paddr      dq Segment.n.ADDRESS
                .n.p_filesz     dq Segment.n.SIZE_IN_FILE
                .n.p_memsz      dq Segment.n.SIZE_IN_MEMORY
                .n.p_align      dq Segment.n.ALIGN
        end repeat
end if

SEGMENT_HEADER_LENGTH <span class="code_symbol">:=</span> <span class="code_symbol">(</span>$ <span class="code_symbol">-</span> ProgramHeader<span class="code_symbol">)</span> <span class="code_symbol">/</span> NUMBER_OF_SEGMENTS

virtual at <span class="code_number">0</span>
        if CLASS <span class="code_symbol">=</span> ELFCLASS32
                .sh_name        dd ?
                .sh_type        dd ?
                .sh_flags       dd ?
                .sh_addr        dd ?
                .sh_offset      dd ?
                .sh_size        dd ?
                .sh_link        dd ?
                .sh_info        dd ?
                .sh_addralign   dd ?
                .sh_entsize     dd ?
        else
                .sh_name        dd ?
                .sh_type        dd ?
                .sh_flags       dq ?
                .sh_addr        dq ?
                .sh_offset      dq ?
                .sh_size        dq ?
                .sh_link        dd ?
                .sh_info        dd ?
                .sh_addralign   dq ?
                .sh_entsize     dq ?
        end if
        SECTION_HEADER_LENGTH <span class="code_symbol">:=</span> $
end virtual


NUMBER_OF_SEGMENTS <span class="code_symbol">:=</span> <span class="code_number">2</span>

Segment.1.TYPE <span class="code_symbol">:=</span> PT_LOAD
Segment.1.FLAGS <span class="code_symbol">:=</span> PF_R<span class="code_symbol">+</span>PF_X
Segment.1.ALIGN <span class="code_symbol">:=</span> <span class="code_number">1000h</span>
Segment.1.OFFSET <span class="code_symbol">:=</span> <span class="code_number">0</span>
Segment.1.ADDRESS <span class="code_symbol">:=</span> BASE_ADDRESS

        start<span class="code_symbol">:</span>

        if MACHINE <span class="code_symbol">=</span> EM_386

                mov     eax<span class="code_symbol">,</span><span class="code_number">4</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_write</span>
                mov     ebx<span class="code_symbol">,</span><span class="code_number">1</span>
                mov     ecx<span class="code_symbol">,</span>msg
                mov     edx<span class="code_symbol">,</span>msg.length
                int     <span class="code_number">0x80</span>

                mov     eax<span class="code_symbol">,</span><span class="code_number">1</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_exit</span>
                xor     ebx<span class="code_symbol">,</span>ebx
                int     <span class="code_number">0x80</span>

        else if MACHINE <span class="code_symbol">=</span> EM_X86_64

                mov     eax<span class="code_symbol">,</span><span class="code_number">1</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_write</span>
                mov     edi<span class="code_symbol">,</span><span class="code_number">1</span>
                lea     rsi<span class="code_symbol">,[</span>msg<span class="code_symbol">]</span>
                mov     edx<span class="code_symbol">,</span>msg.length
                syscall

                mov     eax<span class="code_symbol">,</span><span class="code_number">60</span>          <span class="code_annotation">;</span> <span class="code_annotation">sys_exit</span>
                xor     edi<span class="code_symbol">,</span>edi
                syscall

        else if MACHINE <span class="code_symbol">=</span> EM_AARCH64

                mov     x8<span class="code_symbol">,</span><span class="code_number">64</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_write</span>
                mov     x0<span class="code_symbol">,</span><span class="code_number">1</span>
                adr     x1<span class="code_symbol">,</span>msg
                mov     x2<span class="code_symbol">,</span>msg.length
                svc     <span class="code_number">0</span>

                mov     x8<span class="code_symbol">,</span><span class="code_number">93</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_exit</span>
                mov     x0<span class="code_symbol">,</span><span class="code_number">0</span>
                svc     <span class="code_number">0</span>

        end if

Segment.1.SIZE_IN_FILE <span class="code_symbol">:=</span> $%% <span class="code_symbol">-</span> Segment.1.OFFSET
Segment.1.SIZE_IN_MEMORY <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> Segment.1.ADDRESS

Segment.2.TYPE <span class="code_symbol">:=</span> PT_LOAD
Segment.2.FLAGS <span class="code_symbol">:=</span> PF_R<span class="code_symbol">+</span>PF_W
Segment.2.ALIGN <span class="code_symbol">:=</span> <span class="code_number">1000h</span>
Segment.2.OFFSET <span class="code_symbol">=</span> $%%
align Segment.2.ALIGN
Segment.2.ADDRESS <span class="code_symbol">:=</span> $ <span class="code_symbol">+</span> Segment.2.OFFSET and <span class="code_symbol">(</span>Segment.2.ALIGN<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span>
section Segment.2.ADDRESS

        msg db <span class="code_string">"I</span> <span class="code_string">am</span> <span class="code_string">alive</span> <span class="code_string">and</span> <span class="code_string">well!"</span><span class="code_symbol">,</span><span class="code_number">0xA</span>
        .length <span class="code_symbol">=</span> $ <span class="code_symbol">-</span> .

Segment.2.SIZE_IN_FILE <span class="code_symbol">:=</span> $%% <span class="code_symbol">-</span> Segment.2.OFFSET
Segment.2.SIZE_IN_MEMORY <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> Segment.2.ADDRESS    </pre></div>
<br>

<br>
    <div class="quotecontainer"><div class="quoteheader">Code:</div><pre>macro align? pow2<span class="code_symbol">*,</span>value<span class="code_symbol">:</span>?
        db  <span class="code_symbol">(-</span>$<span class="code_symbol">)</span> and <span class="code_symbol">(</span>pow2<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span>  dup value
end macro

macro use? file<span class="code_symbol">*</span>
        include file
end macro

use <span class="code_string">'elf.inc'</span>

if MACHINE <span class="code_symbol">=</span> EM_386
        CLASS <span class="code_symbol">:=</span> ELFCLASS32
        BASE_ADDRESS <span class="code_symbol">:=</span> <span class="code_number">0x8048000</span>
        use <span class="code_string">'80386.inc'</span>
        use32
else if MACHINE <span class="code_symbol">=</span> EM_X86_64
        CLASS <span class="code_symbol">:=</span> ELFCLASS64
        BASE_ADDRESS <span class="code_symbol">:=</span> <span class="code_number">0x400000</span>
        use <span class="code_string">'x64.inc'</span>
        use64
else if MACHINE <span class="code_symbol">=</span> EM_AARCH64
        CLASS <span class="code_symbol">:=</span> ELFCLASS64
        BASE_ADDRESS <span class="code_symbol">:=</span> <span class="code_number">0x400000</span>
        use <span class="code_string">'aarch64.inc'</span>
end if

org BASE_ADDRESS

Header<span class="code_symbol">:</span>

        .e_ident        db <span class="code_number">0x7F</span><span class="code_symbol">,</span> <span class="code_string">'ELF'</span><span class="code_symbol">,</span> CLASS<span class="code_symbol">,</span> ELFDATA2LSB<span class="code_symbol">,</span> EV_CURRENT<span class="code_symbol">,</span> ELFOSABI_LINUX<span class="code_symbol">,</span> <span class="code_symbol">(</span>.e_ident<span class="code_symbol">+</span><span class="code_number">16</span><span class="code_symbol">-</span>$<span class="code_symbol">)</span> dup <span class="code_number">0</span>
        .e_type         dw ET_EXEC
        .e_machine      dw MACHINE
        .e_version      dd EV_CURRENT
if CLASS <span class="code_symbol">=</span> ELFCLASS32
        .e_entry        dd start
        .e_phoff        dd PROGRAM_HEADER_OFFSET
        .e_shoff        dd <span class="code_number">0</span>
else
        .e_entry        dq start
        .e_phoff        dq PROGRAM_HEADER_OFFSET
        .e_shoff        dq <span class="code_number">0</span>
end if
        .e_flags        dd <span class="code_number">0</span>
        .e_ehsize       dw HEADER_LENGTH
        .e_phentsize    dw SEGMENT_HEADER_LENGTH
        .e_phnum        dw NUMBER_OF_SEGMENTS
        .e_shentsize    dw SECTION_HEADER_LENGTH
        .e_shnum        dw <span class="code_number">0</span>
        .e_shstrndx     dw <span class="code_number">0</span>

HEADER_LENGTH <span class="code_symbol">:=</span> $%

SEGMENT_NUMBER <span class="code_symbol">=</span> <span class="code_number">0</span>
HEADERS_UNMAPPED <span class="code_symbol">=</span> <span class="code_number">1</span>

macro segment? type<span class="code_symbol">,</span> flags<span class="code_symbol">:</span>PF_R

        SEGMENT_NUMBER <span class="code_symbol">=</span> SEGMENT_NUMBER <span class="code_symbol">+</span> <span class="code_number">1</span>

        local SEGMENT_BASE<span class="code_symbol">,</span> SEGMENT_OFFSET

        repeat <span class="code_number">1</span><span class="code_symbol">,</span> n<span class="code_symbol">:</span>SEGMENT_NUMBER

                Segment.n.TYPE <span class="code_symbol">:=</span> type
                Segment.n.FLAGS <span class="code_symbol">:=</span> flags

                if Segment.n.TYPE <span class="code_symbol">=</span> PT_LOAD
                        Segment.n.ALIGN <span class="code_symbol">:=</span> <span class="code_number">1000h</span>
                else
                        Segment.n.ALIGN <span class="code_symbol">:=</span> <span class="code_number">1</span>
                end if

                if HEADERS_UNMAPPED <span class="code_symbol">&amp;</span> Segment.n.TYPE <span class="code_symbol">=</span> PT_LOAD
                        SEGMENT_OFFSET <span class="code_symbol">=</span> <span class="code_number">0</span>
                        SEGMENT_BASE <span class="code_symbol">=</span> BASE_ADDRESS
                        HEADERS_UNMAPPED <span class="code_symbol">=</span> <span class="code_number">0</span>
                else
                        SEGMENT_OFFSET <span class="code_symbol">=</span> $%%
                        if Segment.n.TYPE <span class="code_symbol">=</span> PT_LOAD
                                align Segment.n.ALIGN
                                section $ <span class="code_symbol">+</span> SEGMENT_OFFSET and <span class="code_symbol">(</span>Segment.n.ALIGN<span class="code_symbol">-</span><span class="code_number">1</span><span class="code_symbol">)</span>
                        end if
                        SEGMENT_BASE <span class="code_symbol">=</span> $
                end if

                macro end?.segment?
                        Segment.n.OFFSET <span class="code_symbol">:=</span> SEGMENT_OFFSET
                        Segment.n.ADDRESS <span class="code_symbol">:=</span> SEGMENT_BASE
                        Segment.n.SIZE_IN_FILE <span class="code_symbol">:=</span> $%% <span class="code_symbol">-</span> SEGMENT_OFFSET
                        Segment.n.SIZE_IN_MEMORY <span class="code_symbol">:=</span> $ <span class="code_symbol">-</span> SEGMENT_BASE
                end macro

        end repeat

end macro

postpone
        NUMBER_OF_SEGMENTS <span class="code_symbol">:=</span> SEGMENT_NUMBER
        if HEADERS_UNMAPPED
                err <span class="code_string">'At</span> <span class="code_string">least</span> <span class="code_string">one</span> <span class="code_string">PT_LOAD</span> <span class="code_string">segment</span> <span class="code_string">should</span> <span class="code_string">be</span> <span class="code_string">present'</span>
        end if
end postpone

segment PT_PHDR<span class="code_symbol">,</span> PF_R

        PROGRAM_HEADER_OFFSET <span class="code_symbol">:=</span> $%

        ProgramHeader<span class="code_symbol">:</span>

        if CLASS <span class="code_symbol">=</span> ELFCLASS32
                repeat NUMBER_OF_SEGMENTS<span class="code_symbol">,</span> n<span class="code_symbol">:</span><span class="code_number">1</span>
                        .n.p_type       dd Segment.n.TYPE
                        .n.p_offset     dd Segment.n.OFFSET
                        .n.p_vaddr      dd Segment.n.ADDRESS
                        .n.p_paddr      dd Segment.n.ADDRESS
                        .n.p_filesz     dd Segment.n.SIZE_IN_FILE
                        .n.p_memsz      dd Segment.n.SIZE_IN_MEMORY
                        .n.p_flags      dd Segment.n.FLAGS
                        .n.p_align      dd Segment.n.ALIGN
                end repeat
        else
                repeat NUMBER_OF_SEGMENTS<span class="code_symbol">,</span> n<span class="code_symbol">:</span><span class="code_number">1</span>
                        .n.p_type       dd Segment.n.TYPE
                        .n.p_flags      dd Segment.n.FLAGS
                        .n.p_offset     dq Segment.n.OFFSET
                        .n.p_vaddr      dq Segment.n.ADDRESS
                        .n.p_paddr      dq Segment.n.ADDRESS
                        .n.p_filesz     dq Segment.n.SIZE_IN_FILE
                        .n.p_memsz      dq Segment.n.SIZE_IN_MEMORY
                        .n.p_align      dq Segment.n.ALIGN
                end repeat
        end if

        SEGMENT_HEADER_LENGTH <span class="code_symbol">:=</span> <span class="code_symbol">(</span>$ <span class="code_symbol">-</span> ProgramHeader<span class="code_symbol">)</span> <span class="code_symbol">/</span> NUMBER_OF_SEGMENTS

end segment

virtual at <span class="code_number">0</span>
        if CLASS <span class="code_symbol">=</span> ELFCLASS32
                .sh_name        dd ?
                .sh_type        dd ?
                .sh_flags       dd ?
                .sh_addr        dd ?
                .sh_offset      dd ?
                .sh_size        dd ?
                .sh_link        dd ?
                .sh_info        dd ?
                .sh_addralign   dd ?
                .sh_entsize     dd ?
        else
                .sh_name        dd ?
                .sh_type        dd ?
                .sh_flags       dq ?
                .sh_addr        dq ?
                .sh_offset      dq ?
                .sh_size        dq ?
                .sh_link        dd ?
                .sh_info        dd ?
                .sh_addralign   dq ?
                .sh_entsize     dq ?
        end if
        SECTION_HEADER_LENGTH <span class="code_symbol">:=</span> $
end virtual

segment PT_LOAD<span class="code_symbol">,</span> PF_R<span class="code_symbol">+</span>PF_X

        start<span class="code_symbol">:</span>

        if MACHINE <span class="code_symbol">=</span> EM_386

                mov     eax<span class="code_symbol">,</span><span class="code_number">4</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_write</span>
                mov     ebx<span class="code_symbol">,</span><span class="code_number">1</span>
                mov     ecx<span class="code_symbol">,</span>msg
                mov     edx<span class="code_symbol">,</span>msg.length
                int     <span class="code_number">0x80</span>

                mov     eax<span class="code_symbol">,</span><span class="code_number">1</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_exit</span>
                xor     ebx<span class="code_symbol">,</span>ebx
                int     <span class="code_number">0x80</span>

        else if MACHINE <span class="code_symbol">=</span> EM_X86_64

                mov     eax<span class="code_symbol">,</span><span class="code_number">1</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_write</span>
                mov     edi<span class="code_symbol">,</span><span class="code_number">1</span>
                lea     rsi<span class="code_symbol">,[</span>msg<span class="code_symbol">]</span>
                mov     edx<span class="code_symbol">,</span>msg.length
                syscall

                mov     eax<span class="code_symbol">,</span><span class="code_number">60</span>          <span class="code_annotation">;</span> <span class="code_annotation">sys_exit</span>
                xor     edi<span class="code_symbol">,</span>edi
                syscall

        else if MACHINE <span class="code_symbol">=</span> EM_AARCH64

                mov     x8<span class="code_symbol">,</span><span class="code_number">64</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_write</span>
                mov     x0<span class="code_symbol">,</span><span class="code_number">1</span>
                adr     x1<span class="code_symbol">,</span>msg
                mov     x2<span class="code_symbol">,</span>msg.length
                svc     <span class="code_number">0</span>

                mov     x8<span class="code_symbol">,</span><span class="code_number">93</span>           <span class="code_annotation">;</span> <span class="code_annotation">sys_exit</span>
                mov     x0<span class="code_symbol">,</span><span class="code_number">0</span>
                svc     <span class="code_number">0</span>

        end if

end segment

segment PT_LOAD<span class="code_symbol">,</span> PF_R<span class="code_symbol">+</span>PF_W

        msg db <span class="code_string">"I</span> <span class="code_string">am</span> <span class="code_string">alive</span> <span class="code_string">and</span> <span class="code_string">well!"</span><span class="code_symbol">,</span><span class="code_number">0xA</span>
        .length <span class="code_symbol">=</span> $ <span class="code_symbol">-</span> .

end segment    </pre></div></div>

<div class="signature"></div><span class="smalltext"><br><br>Last edited by Tomasz Grysztar on 05 Feb 2023, 19:48; edited 14 times in total</span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row1"><a href="https://board.flatassembler.net/topic.php?p=205881#205881"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  08 Sep 2018, 16:32</span></td>
                <td valign="middle" class="row1">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=205881"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            <table class="grid" style="table-layout:fixed;white-space:normal;">
              <tbody><tr>
                <td valign="top" class="leftcol foldable row2">
                  <div style="overflow-x: hidden;">
                  <span class="largetext"><b>Tomasz Grysztar</b></span><br>
                  <span class="smalltext"><br>
                  <br>
                  <br>
                  Joined: 16 Jun 2003<br>
                  Posts: 8349<br>
                  Location: Krak√≥w, Poland</span>
                  <div></div></div></td>
                <td valign="top" class="postbody row2">
                  <a name="208914"></a>
                  <div class="folded postheader"><b>Tomasz Grysztar</b> <span class="smalltext">23 Feb 2019, 17:11</span></div>
                  <div class="largetext" style="padding-bottom: 2px;" title="">It may take quite some time before I manage to finish the chapter on ELF, and Mach-O seems almost out of sight. If you can't wait, you may at least take a look at the sets of macros I made for creation of Mach-O <a href="https://board.flatassembler.net/topic.php?t=20066" target="_blank" class="postlink">executables</a> and  <a href="https://board.flatassembler.net/topic.php?t=20088" target="_blank" class="postlink">objects</a>, with a commentary on some issues I encountered.</div>

<div class="signature"></div><span class="smalltext"></span>
                </td>
              </tr>
              <tr>
                <td class="leftcol foldable row2"><a href="https://board.flatassembler.net/topic.php?p=208914#208914"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_minipost.gif" alt="Post" title="Post" border="0"></a><span class="smalltext">
                  23 Feb 2019, 17:11</span></td>
                <td valign="middle" class="row2">
                  <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tbody><tr valign="bottom">
                      <td nowrap=""> <a href="https://board.flatassembler.net/profile.php?mode=viewprofile&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_profile.gif" alt="View user&#39;s profile" title="View user&#39;s profile" border="0"></a>
                        <span class="foldable"> <a href="https://board.flatassembler.net/privmsg.php?mode=post&amp;u=2"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_pm.gif" alt="Send private message" title="Send private message" border="0"></a>  <a href="https://github.com/tgrysztar" target="_userwww"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_www.gif" alt="Visit poster&#39;s website" title="Visit poster&#39;s website" border="0"></a>     </span></td>
                      <td align="right" nowrap="">  <a href="https://board.flatassembler.net/post.php?mode=quote&amp;p=208914"><img src="./flat assembler - Learning binary file formats (work in progress)_files/icon_quote.gif" alt="Reply with quote" title="Reply with quote" border="0"></a>  </td>
                    </tr>
                  </tbody></table>
                </td>
              </tr>
            </tbody></table>
            

             <table class="grid">
               <tbody><tr>
                  <td align="center" width="100%" class="toprow">
                    <form method="post" action="https://board.flatassembler.net/topic.php?t=20690&amp;start=0">
                     <table width="100%" border="0" cellpadding="2" cellspacing="1">
                       <tbody><tr>
                         <td align="left" width="100%" class="foldable">
                           <table border="0" cellspacing="0" cellpadding="0">
                             <tbody><tr>
                               <td valign="middle"><span class="toprowtext">  Display posts from previous:</span></td>
                               <td valign="middle"><span class="toprowtext">  <select name="postdays"><option value="0" selected="selected">All Posts</option><option value="1">1 Day</option><option value="7">7 Days</option><option value="14">2 Weeks</option><option value="30">1 Month</option><option value="90">3 Months</option><option value="180">6 Months</option><option value="364">1 Year</option></select> <select name="postorder"><option value="asc" selected="selected">Oldest First</option><option value="desc">Newest First</option></select></span></td>
                               <td align="left" valign="middle"><span class="toprowtext">
                                     <input type="image" src="./flat assembler - Learning binary file formats (work in progress)_files/gobutton.gif" align="middle" name="image">
                                </span>
                                </td>
                             </tr>
                           </tbody></table>
                         </td>
                         <td align="right" width="2%" nowrap=""><a href="https://board.flatassembler.net/post.php?mode=newtopic&amp;f=27"><img src="./flat assembler - Learning binary file formats (work in progress)_files/post.gif" border="0" alt="Post new topic" align="middle"></a> <a href="https://board.flatassembler.net/post.php?mode=reply&amp;t=20690"><img src="./flat assembler - Learning binary file formats (work in progress)_files/reply-locked.gif" border="0" alt="This topic is locked: you cannot edit posts or make replies." align="middle"></a></td>
                        </tr>
                     </tbody></table>
                    </form>
                  </td>
               </tr>
            </tbody></table>


<table class="lineup">
    <tbody><tr valign="top">
      <td align="left" class="foldable"><span class="smalltext"><a href="https://board.flatassembler.net/topic.php?t=20690"></a><br>
        </span>
        <table cellpadding="0" cellspacing="0" border="0">
          <tbody><tr>
            <td>
              
<form method="post" name="jumpbox" action="https://board.flatassembler.net/forum.php">
  <table cellspacing="0" cellpadding="0" border="0">
	<tbody><tr>
	  <td nowrap="" valign="middle"><span class="smalltext">Jump to:&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ forms[&#39;jumpbox&#39;].submit() }"><option value="-1">Select a forum</option><option value="-1">&nbsp;</option><option value="-1">Official</option><option value="-1">----------------</option><option value="27" selected="selected">Assembly</option><option value="28">Peripheria</option><option value="-1">&nbsp;</option><option value="-1">General</option><option value="-1">----------------</option><option value="13">Main</option><option value="23">Tutorials and Examples</option><option value="2">DOS</option><option value="3">Windows</option><option value="4">Linux</option><option value="17">Unix</option><option value="12">MenuetOS</option><option value="-1">&nbsp;</option><option value="-1">Specific</option><option value="-1">----------------</option><option value="14">Macroinstructions</option><option value="11">OS Construction</option><option value="15">IDE Development</option><option value="21">Projects and Ideas</option><option value="22">Non-x86 architectures</option><option value="19">High Level Languages</option><option value="26">Programming Language Design</option><option value="9">Compiler Internals</option><option value="-1">&nbsp;</option><option value="-1">Other</option><option value="-1">----------------</option><option value="7">Feedback</option><option value="8">Heap</option><option value="10">Test Area</option></select><input type="hidden" name="sid" value="">&nbsp;</span>
		<input type="image" src="./flat assembler - Learning binary file formats (work in progress)_files/gobutton.gif" align="top">
		</td>
	</tr>
  </tbody></table>
</form>

</td>
          </tr>
        </tbody></table>
        <span class="smalltext"> </span></td>
      <td align="right"><span class="smalltext"><br>
        <br>
      </span><span class="smalltext">&lt;  <a href="https://board.flatassembler.net/topic.php?t=20690&amp;view=previous" class="smalltext">Last
      Thread</a> | <a href="https://board.flatassembler.net/topic.php?t=20690&amp;view=next" class="smalltext">Next Thread
      </a> &gt;</span><span class="smalltext"> </span></td>
    </tr>
  </tbody></table>

  <table class="lineup">
    <tbody><tr valign="bottom">
      <td align="left"><span class="smalltext"><b>Forum Rules:</b></span> <br>
              <table class="grid" style="width:auto;">
                <tbody><tr>
                  <td class="row2"><span class="smalltext">You <b>cannot</b> post new topics in this forum<br>You <b>cannot</b> reply to topics in this forum<br>You <b>cannot</b> edit your posts in this forum<br>You <b>cannot</b> delete your posts in this forum<br>You <b>cannot</b> vote in polls in this forum<br>You <b>cannot</b> attach files in this forum<br>You <b>can</b> download files in this forum<br></span>
                  </td>
                </tr>
              </tbody></table>
      </td>

    <td align="center">
       <!-- Ad placeholder -->
    </td>

    <td align="right"><span class="gensmall"></span><br>
       <br>
      </td>
    </tr>
  </tbody></table>



  </div>

  <p class="navigation">
    <a class="boldlink" href="http://flatassembler.net/index.php">Main&nbsp;index</a>
    <a class="boldlink" href="http://flatassembler.net/download.php">Download</a>
    <a class="boldlink" href="http://flatassembler.net/docs.php">Documentation</a>
    <a class="boldlink" href="http://flatassembler.net/examples.php">Examples</a>
    <a class="boldlink" href="http://board.flatassembler.net/">Message&nbsp;board</a>
  </p>

  <p>
     Copyright ¬© 1999-2024, <a href="mailto:tgrysztar@flatassembler.net">Tomasz Grysztar</a>. Also on <a href="https://github.com/tgrysztar">GitHub</a>, <a href="http://www.youtube.com/c/flatassembler">YouTube</a>.
  </p>

  <p>
     Website powered by <a href="https://2ton.com.au/rwasa/" title="rwasa web server">rwasa</a>.
  </p>




</body></html>